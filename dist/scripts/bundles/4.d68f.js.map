{"version":3,"sources":["webpack:///./src/scripts/modify-rolling.js"],"names":["async","onChatCardAction","ev","currentTarget","dataset","action","renderAttack","placeTemplate","renderTemplate","this","_onChatCardAction","getToHitData","actor","item","hasAttack","actorData","data","itemData","flags","dnd5e","rollData","getRollData","parts","type","proficient","push","actorBonus","bonuses","actionType","attackBonus","attack","filterJoin","weaponCriticalThreshold","critical","parseInt","includes","elvenAccuracy","abilityMod","halflingLucky","roll","Roll","join","totalModifier","_safeEval","formula","terms","_formula","getDmgsData","spellLevel","hasDamage","level","duplicate","damage","versatile","splice","scaling","mode","newDmgPart","lvl","details","_scaleCantripDamage","_scaleSpellDamage","length","part","rollHit","button","disabled","card","closest","messageId","CONFIG","Item","entityClass","_getChatCardActor","owner","getOwnedItem","itemId","ui","notifications","error","name","adv","game","settings","get","userId","nd","mods","unshift","r","div","document","createElement","title","total","classList","add","span","appendChild","innerText","insertAdjacentHTML","getTooltip","childNodes","crit","fumble","d20","querySelector","innerHTML","querySelectorAll","forEach","e","idx","alter","parentNode","replaceChild","messages","update","content","rollDmg","autoRoll","autoroll","template","hit","toHitBtn","dmg","btns","Array","from","btn","preventDefault","stopPropagation","targets","user","areaSkill","Object","keys","DND5E","areaTargetTypes","getProperty","size","img","attackData","toHit","dmgs","sceneId","canvas","scene","id","target","attackTemplateData","flavor","chatFlavor","replace","html","ChatMessage","create","_id","CONST","CHAT_MESSAGE_TYPES","OTHER","speaker","token","alias","getTargetToken","tokenId","targetId","tokens","placeables","find","onMouseEnterTarget","_onHoverIn","onMouseLeaveTarget","visible","_onHoverOut","onDblClickTarget","pos","center","animatePan","x","y","isTokenInside","grid","templatePos","startX","width","startY","height","currGrid","shape","contains","getTargets","getEmbeddedCollection","updateTokenTargets","itemHook","app","formField","inp","dtype","value","object","getFlag","style","flex","_activateFilePicker","after","modifyRolling","register","default","String","scope","Hooks","on","advSelector","templateData","advantage","normal","disadvantage","addEventListener","remove","set","toggle","createControls","controls","insertBefore","chatListeners","bind","_onChatCardToggleContent","importedJS","import","AbilityTemplate","_originalFromItem","fromItem","path","t","loadTexture","then","tex","texture","refresh","newFun","prototype","activatePreviewListeners","toString","Function","changeAbilityTemplate"],"mappings":"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","file":"bundles/4.d68f.js","sourcesContent":["async function createControls() {\n\tconst div = document.createElement('div');\n\tdiv.classList.add('mess-roll-control');\n\n\tconst advSelector = game.settings.get('mess', `${game.userId}.adv-selector`);\n\tconst autoRollSelector = game.settings.get('mess', `${game.userId}.autoroll-selector`);\n\tconst templateData = {\n\t\tadvantage: advSelector === 'advantage',\n\t\tnormal: advSelector ===  'normal',\n\t\tdisadvantage: advSelector ===  'disadvantage',\n\t\t...autoRollSelector\n\t}\n\n\tdiv.insertAdjacentHTML('afterbegin', await renderTemplate('modules/mess/templates/roll-control.html', templateData));\n\n\tdiv.querySelectorAll('.mess-adv-selector a').forEach(e => {\n\t\te.addEventListener('click', async function(ev) {\n\t\t\tev.preventDefault();\n\t\t\tev.stopPropagation();\n\n\t\t\tif (ev.currentTarget.classList.contains('mess-selected')) return false;\n\n\t\t\tev.currentTarget.parentNode.querySelector('.mess-selected').classList.remove('mess-selected');\n\t\t\tev.currentTarget.classList.add('mess-selected');\n\n\t\t\tgame.settings.set('mess', `${game.userId}.adv-selector`, ev.currentTarget.name);\n\t\t});\n\t});\n\tdiv.querySelectorAll('.mess-autoroll-selector a') .forEach(e => {\n\t\te.addEventListener('click', async function(ev) {\n\t\t\tev.preventDefault();\n\t\t\tev.stopPropagation();\n\n\t\t\t\n\t\t\tev.currentTarget.classList.toggle('mess-selected');\n\t\t\tlet data = game.settings.get('mess', `${game.userId}.autoroll-selector`);\n\t\t\tdata[ev.currentTarget.name] = ev.currentTarget.classList.contains('mess-selected');\n\t\t\tgame.settings.set('mess', `${game.userId}.autoroll-selector`, data);\n\t\t})\n\t})\n\treturn div;\n}\n\n// Only overwrite stuff for attack buttons\nasync function onChatCardAction (ev) {\n\tif (ev.currentTarget.dataset.action === 'attack')\n\t\treturn renderAttack(ev);\n\tif (ev.currentTarget.dataset.action === 'damage')\n\t\treturn renderAttack(ev);\n\tif (ev.currentTarget.dataset.placeTemplate)\n\t\treturn renderTemplate(ev);\n\n\treturn this._onChatCardAction(ev);\t\t\n}\n\nasync function getToHitData({actor, item}) {\n\tif (!item.hasAttack) return null;\n\tconst actorData = actor.data.data;\n\tconst itemData = item.data.data;\n\tconst flags = actor.data.flags.dnd5e || {};\n\t\n\tlet rollData = item.getRollData();\n\n\t// Define Roll bonuses\n\tconst parts = [`@mod`];\n\tif ( (item.data.type !== \"weapon\") || itemData.proficient ) {\n\t\tparts.push(\"@prof\");\n\t}\n\trollData.parts = parts;\n\t// Attack Bonus\n\tconst actorBonus = actorData.bonuses[itemData.actionType] || {};\n\tif ( itemData.attackBonus || actorBonus.attack ) {\n\t\tparts.push(\"@atk\");\n\t\trollData[\"atk\"] = [itemData.attackBonus, actorBonus.attack].filterJoin(\" + \");\n\t}\n\n\t// Expanded weapon critical threshold\n\tif (( item.data.type === \"weapon\" ) && flags.weaponCriticalThreshold) {\n\t\trollData.critical = parseInt(flags.weaponCriticalThreshold);\n\t}\n\n\t// Elven Accuracy\n\tif ( [\"weapon\", \"spell\"].includes(item.data.type) ) {\n\t\tif (flags.elvenAccuracy && [\"dex\", \"int\", \"wis\", \"cha\"].includes(item.abilityMod)) {\n\t\t\trollData.elvenAccuracy = true;\n\t\t}\n\t}\n\n\t// Apply Halfling Lucky\n\tif ( flags.halflingLucky ) rollData.halflingLucky = true;\n\t\n\t// rollData.formula = rollData.parts.join(\" + \");\n\tconst roll = new Roll(rollData.parts.join('+'), rollData);\n\trollData.totalModifier = roll._safeEval(roll.formula);\n\trollData.totalModifier = rollData.totalModifier >= 0 ? '+' + rollData.totalModifier : rollData.totalModifier;\n\trollData.formula = roll.formula;\n\trollData.terms = roll._formula;\n\treturn rollData;\n}\n\nasync function getDmgsData({actor, item, spellLevel = null}) {\n\tif (!item.hasDamage) return null;\n\tconst actorData = actor.data.data;\n\tconst itemData = item.data.data;\n\tlet rollData = item.getRollData();\n\t\n\tif ( spellLevel ) rollData.item.level = spellLevel;\n\n\trollData.parts = duplicate(itemData.damage.parts);\n\tif (itemData.damage.versatile) \n\t\trollData.parts.splice(1, 0, [itemData.damage.versatile, \"versatile\"]);\n\t\n\tif (item.data.type === 'spell') {\n\t\tif (itemData.scaling.mode === 'cantrip') {\n\t\t\tlet newDmgPart = [rollData.parts[0][0]];\n\t\t\tconst lvl = actor.data.type === 'character' ? actorData.details.level : actorData.details.spellLevel;\n\t\t\titem._scaleCantripDamage(newDmgPart, lvl, itemData.scaling.formula);\n\t\t\trollData.parts[0][0] = newDmgPart[0];\n\t\t} else if (spellLevel && (itemData.scaling.mode === 'level') && itemData.scaling.formula ) {\n\t\t\tlet newDmgPart = [];\n\t\t\titem._scaleSpellDamage(newDmgPart, itemData.level, spellLevel, itemData.scaling.formula)\n\t\t\tif (newDmgPart.length > 0) {\n\t\t\t\tnewDmgPart.push('upcast dice');\n\t\t\t\trollData.parts.push(newDmgPart);\n\t\t\t}\n\t\t}\n\t}\n\t\n\tconst actorBonus = actorData.bonuses[itemData.actionType] || {};\n\tif (actorBonus.damage && parseInt(actorBonus.damage ) !== 0) {\n\t\tparts[0][0] += \"+@dmg\";\n\t\trollData[\"dmg\"] = actorBonus.damage;\n\t}\n\n\tfor (let part of rollData.parts) {\n\t\tlet roll = new Roll(part[0], rollData);\n\t\tpart.push(roll.formula);\n\t}\n\n\treturn rollData;\n}\n\nasync function rollHit(ev) {\n\t// Extract card data\n\tconst button = ev.currentTarget;\n\tbutton.disabled = true;\n\tconst card = button.closest(\".chat-card\");\n\tconst messageId = card.closest(\".message\").dataset.messageId;\n\n\t// Get the Actor from a synthetic Token\n\tconst actor = CONFIG.Item.entityClass._getChatCardActor(card);\n\tif (!actor.owner) return false;\n\n\t// Get the Item\n\tconst item = actor.getOwnedItem(card.dataset.itemId);\n\tif ( !item ) {\n\t\treturn ui.notifications.error(`The requested item ${card.dataset.itemId} no longer exists on Actor ${actor.name}`)\n\t}\n\n\tlet rollData = await getToHitData({actor, item});\n\tlet adv = game.settings.get('mess', `${game.userId}.adv-selector`);\n\t// Determine the d20 roll and modifiers\n\tlet nd = 1;\n\tlet mods = rollData.halflingLucky ? \"r=1\" : \"\";\n\n\t// Handle advantage\n\tif ( adv === \"advantage\" ) {\n\t\tnd = rollData.elvenAccuracy ? 3 : 2;\n\t\tmods += \"kh\";\n\t}\n\n\t// Handle disadvantage\n\telse if ( adv === \"disadvantage\" ) {\n\t\tnd = 2;\n\t\tmods += \"kl\";\n\t}\n\n\t// Include the d20 roll\n\trollData.parts.unshift(`${nd}d20${mods}`);\n\n\tlet r = new Roll(rollData.parts.join('+'), rollData);\n\tr.roll();\n\tlet div = document.createElement('div');\n\tdiv.title = `${rollData.parts[0]}+${rollData.terms} = ${r.formula} = ${r.total}. Click to see rolls.`;\n\tdiv.classList.add('dice-roll');\n\tdiv.classList.add('mess-dice-result');\n\tconst span = div.appendChild(document.createElement('span'));\n\tspan.innerText = r.total;\n\tdiv.insertAdjacentHTML('beforeend', await r.getTooltip());\n\tconst tooltip = div.childNodes[1];\n\ttooltip.classList.add('hidden');\n\tconst crit = rollData.critical || 20;\n\tconst fumble = rollData.fumble || 1;\n\n\tconst d20 = r.parts[0].total;\n\tif (d20 >= crit) {\n\t\tspan.classList.add('crit');\n\t\tcard.querySelector('.mess-chat-dmg .mess-chat-roll-type').innerHTML += ' - Crit!'\n\t\tcard.querySelectorAll('.mess-button-dmg').forEach((e, idx) => {\n\t\t\tconst formula = e.dataset.formula;\n\t\t\tconst r = new Roll(formula);\n\t\t\tr.alter(0, 2);\n\t\t\te.innerHTML = `<i class=\"fas fa-dice-d20\"></i> ${r.formula}`\n\t\t\te.dataset.formula = r.formula;\n\t\t});\n\t}\n\tif (d20 <= fumble)\n\t\tspan.classList.add('fumble');\n\n\tev.currentTarget.parentNode.replaceChild(div, ev.currentTarget);\n\tif (messageId) {\n\t\tconst message = game.messages.get(messageId);\n\t\tmessage.update({content: card.parentNode.innerHTML});\n\t}\n}\n\nasync function rollDmg(ev) {\n\t// Extract card data\n\tconst button = ev.currentTarget;\n\tbutton.disabled = true;\n\tconst card = button.closest(\".chat-card\");\n\tconst messageId = card.closest(\".message\").dataset.messageId;\n\tconst formula = button.dataset.formula;\n\n\tlet r = new Roll(formula);\n\tr.roll();\n\tlet div = document.createElement('div');\n\tdiv.title = `${button.dataset.terms} = ${r.formula} = ${r.total}. Click to see rolls.`;\n\tdiv.classList.add('dice-roll');\n\tdiv.classList.add('mess-dice-result');\n\tconst span = div.appendChild(document.createElement('span'));\n\tspan.innerText = r.total;\n\tdiv.insertAdjacentHTML('beforeend', await r.getTooltip());\n\tconst tooltip = div.childNodes[1];\n\ttooltip.classList.add('hidden');\n\n\tev.currentTarget.parentNode.replaceChild(div, ev.currentTarget);\n\n\tif (messageId) {\n\t\tconst message = game.messages.get(messageId);\n\t\tmessage.update({content: card.parentNode.innerHTML});\n\t}\n}\n\nasync function autoRoll(autoroll, template) {\n\tlet card = document.createElement('div');\n\tcard.classList.add('message');\n\tcard.insertAdjacentHTML('afterbegin', template);\n\tif (autoroll.hit) {\n\t\tlet toHitBtn = card.querySelector('.mess-button-to-hit');\n\t\tif (toHitBtn)\n\t\t\tawait rollHit({currentTarget: toHitBtn});\n\t}\n\n\tif (autoroll.dmg) {\n\t\tconst btns = Array.from(card.querySelectorAll('.mess-button-dmg'));\n\t\tfor (const btn of btns)\n\t\t\tawait rollDmg({currentTarget: btn});\n\t}\n\treturn card.innerHTML;\n}\n\nasync function renderAttack(ev) {\n\tif (ev.type === 'click') {\n\t\tev.preventDefault();\n\t\tev.stopPropagation();\n\t}\n\n\t// Extract card data\n\tconst button = ev.currentTarget;\n\tbutton.disabled = true;\n\tconst card = button.closest(\".chat-card\");\n\n\t// Get the Actor from a synthetic Token\n\tconst actor = CONFIG.Item.entityClass._getChatCardActor(card);\n\n\tif ( !actor || !actor.owner) return;\n\n\t// Get the Item\n\tconst item = actor.getOwnedItem(card.dataset.itemId);\n\tif ( !item ) {\n\t\treturn ui.notifications.error(`The requested item ${card.dataset.itemId} no longer exists on Actor ${actor.name}`)\n\t}\n\n\tlet targets = game.user.targets;\n\t// Don't roll for all targets if its an AoE, due to only rolling e.g. dmg once for all targets\n\t// TODO: Maybe add target list or chat cards for making saving throws\n\t// or not, since it would just spam the chatlog.. hmm\n\tconst areaSkill = Object.keys(CONFIG.DND5E.areaTargetTypes).includes(getProperty(item, 'data.data.target.type'));\n\tif (!targets.size || areaSkill)\n\t\ttargets =  [{data: {\n\t\t\t\tname: \"someone\",\n\t\t\t\timg: \"\"\n\t\t\t}\n\t\t}];\n\tconst spellLevel = parseInt(card.dataset.spellLevel) || null;\n\n\tconst template = 'modules/mess/templates/attack-card.html';\n\n\tconst attackData = {\n\t\tactor, item,\n\t\ttoHit: await getToHitData({actor, item}),\n\t\tdmgs: await getDmgsData({actor, item, spellLevel}),\n\t\tsceneId: canvas.scene.id\n\t}\n\n\tconst autoroll = game.settings.get('mess', `${game.userId}.autoroll-selector`);\n\n\tfor (const target of targets) {\n\t\tconst attackTemplateData = {\n\t\t\t\t\t\t\t\t\t...attackData, \n\t\t\t\t\t\t\t\t\ttarget: target.data,\n\t\t\t\t\t\t\t\t\tflavor: item.data.data.chatFlavor.replace(/\\[target\\.name\\]/g, target.data.name)\n\t\t\t\t\t\t\t\t};\n\t\tlet html = await renderTemplate(template, attackTemplateData);\n\n\t\tif (autoroll.hit || autoroll.dmg) \n\t\t\thtml = await autoRoll(autoroll, html);\n\n\t\tChatMessage.create({\n      user: game.user._id,\n      type: CONST.CHAT_MESSAGE_TYPES.OTHER,\n      content: html,\n      speaker: {\n        actor: item.actor._id,\n        token: item.actor.token,\n        alias: item.actor.name\n\t\t\t}\n\t\t});\n\t}\n\n\tbutton.disabled = false;\n}\n\nasync function getTargetToken(ev) {\n\tconst card = ev.currentTarget.closest('.mess-attack-card');\n\tconst sceneId = card.dataset.sceneId;\n\tif (sceneId !== canvas.scene.id) return false;\n\tconst tokenId = card.dataset.targetId;\n\tif (!tokenId) return false;\n\n\tconst token = canvas.tokens.placeables.find(e => e.id === tokenId);\n\tif (!token) return false;\n\treturn token;\n}\n\nasync function onMouseEnterTarget(ev) {\n\tev.preventDefault();\n\tev.stopPropagation();\n\tconst token = await getTargetToken(ev);\n\tif (!token) return false;\n\n\ttoken._onHoverIn();\n}\n\nasync function onMouseLeaveTarget(ev) {\n\tev.preventDefault();\n\tev.stopPropagation();\n\tconst token = await getTargetToken(ev);\n\tif (!token || !token.visible) return false;\n\t\n\ttoken._onHoverOut();\n}\n\nasync function onDblClickTarget(ev) {\n\tev.preventDefault();\n\tev.stopPropagation();\n\tconst token = await getTargetToken(ev);\n\tif (!token || !token.visible) return false;\n\t\n\tconst pos = token.center;\n\tcanvas.animatePan({x: pos.x, y: pos.y})\n}\n\n\n\nfunction isTokenInside(token) {\n\tconst grid = canvas.scene.data.grid,\n\t\t\t\ttemplatePos = {x: this.data.x, y: this.data.y};\n\t// Check for center of  each square the token uses.\n\t// e.g. for large tokens all 4 squares\n\tconst startX = token.width >= 1 ? 0.5 : token.width / 2;\n\tconst startY = token.height >= 1 ? 0.5 : token.height / 2;\n\tfor (let x = startX; x < token.width; x++) {\n\t\tfor (let y = startY; y < token.height; y++) {\n\t\t\tconst currGrid = {\n\t\t\t\tx: token.x + x * grid - templatePos.x,\n\t\t\t\ty: token.y + y * grid - templatePos.y\n\t\t\t};\n\t\t\tconst contains = this.shape.contains(currGrid.x, currGrid.y);\n\t\t\tif (contains) return true;\n\t\t}\n\t}\n\treturn false;\n}\n\nfunction getTargets() {\n\n\tconst tokens = canvas.scene.getEmbeddedCollection('Token');\n\tlet targets = [];\n\t\n\tfor (const token of tokens)\n\t\tif (this.isTokenInside(token)) { targets.push(token._id); }\n\tgame.user.updateTokenTargets(targets);\n}\n\nasync function changeAbilityTemplate() {\n\tconst importedJS = (await import(/* webpackIgnore: true */ '/systems/dnd5e/module/pixi/ability-template.js'))\n\tconst AbilityTemplate = importedJS.default || importedJS.AbilityTemplate;\n\n\t\n\tconst _originalFromItem = AbilityTemplate.fromItem;\n\tAbilityTemplate.fromItem = function(item) {\n\t\tconst template = _originalFromItem.bind(this)(item);\n\t\t\n\t\t// generate a texture based on the items dmg type, ...\n\t\t// Add settings to define custom templates for stuff.\n\t\tlet path = item.getFlag('mess', 'templateTexture');\n\t\tif (!path && item.hasDamage) {\n\t\t\tconst settings = game.settings.get('mess', 'templateTexture');\n\t\t\tpath = settings[item.data.data.damage.parts[0][1]][template.data.t];\n\t\t}\n\t\tif (path)\n\t\t\tloadTexture(path).then(tex => {\n\t\t\t\ttemplate.texture = tex;\n\t\t\t\ttemplate.data.texture = path;\n\t\t\t\ttemplate.refresh();\n\t\t\t})\n\t\ttemplate.item = item;\n\t\treturn template;\n\t}\n\n\t//  rather ugly, maybe find a better way at some point :shrug:\n\tconst origPrevListeners = AbilityTemplate.prototype.activatePreviewListeners.toString();\n\tconst newFun = origPrevListeners.replace(/this\\.refresh\\(\\)\\;/, \n\t\t\t\t// get targets\n\t\t\t\t\t`this.refresh();\n\t\t\t\t\tthis.getTargets(this);\n\t\t\t\t`);\n\n\tAbilityTemplate.prototype.getTargets = getTargets;\n\tAbilityTemplate.prototype.isTokenInside = isTokenInside;\n\n\tAbilityTemplate.prototype.activatePreviewListeners = Function(`\"use strict\"; return ( function ${newFun} )`)();\n}\n\nasync function itemHook(app, html) {\n\tconst div = document.createElement('div');\n\tdiv.classList.add('form-group');\n\tdiv.appendChild(document.createElement('label')).innerText = 'Template Texture';\n\tconst formField = div.appendChild(document.createElement('div'));\n\tformField.classList.add('form-fields');\n\tconst inp = formField.appendChild(document.createElement('input'));\n\tinp.dataset.dtype = 'String';\n\tinp.type = 'text';\n\tinp.name = 'flags.mess.templateTexture';\n\tinp.value = app.object.getFlag('mess', 'templateTexture') || \"\";\n\n\tformField.insertAdjacentHTML('beforeend', `\n\t\t<button type=\"button\" class=\"file-picker\" data-type=\"imagevideo\" data-target=\"flags.mess.templateTexture\" title=\"Browse Files\" tabindex=\"-1\">\n\t\t\t<i class=\"fas fa-file-import fa-fw\"></i>\n\t\t</button>\n\t`);\n\tconst button = formField.querySelector('button');\n\tbutton.style.flex = '0';\n\tapp._activateFilePicker(button);\n\thtml[0].querySelector('[name=\"data.target.units\"]').closest('.form-group').after(div);\n}\n\n\nexport default function modifyRolling() {\n\tgame.settings.register('mess', `${game.userId}.adv-selector`, {\n\t\tname: 'Mess - Advantage Selector',\n\t\tdefault: 'normal',\n\t\ttype: String,\n\t\tscope: 'user'\n\t});\n\tgame.settings.register('mess', `${game.userId}.autoroll-selector`, {\n\t\tname: 'Mess - Autoroll Selector',\n\t\tdefault: {hit: false, dmg: false},\n\t\ttype: Object,\n\t\tscope: 'user'\n\t});\n\n\tHooks.on('renderChatLog', async (app, html, data) => {\n\t\tconst div = await createControls();\n\t\tconst controls = html[0].querySelector('#chat-controls');\n\t\tcontrols.insertBefore(div, controls.childNodes[0]);\n\t});\n\n\t// roundabout way to get the listener do what *I* want...\n\t// Since adding my own listener in renderChatLog was \"to early\".\n\tCONFIG.Item.entityClass.chatListeners = function (html) {\n    html.on('click', '.card-buttons button', onChatCardAction.bind(this));\n\t\thtml.on('click', '.item-name', this._onChatCardToggleContent.bind(this));\n\t\t\n\t\t// lets just use this for even more listeners\n\t\thtml.on('mouseenter', '.mess-chat-target', onMouseEnterTarget);\n\t\thtml.on('mouseleave', '.mess-chat-target', onMouseLeaveTarget);\n\t\thtml.on('dblclick', '.mess-chat-target', onDblClickTarget);\n\n\t\thtml.on('click', '.mess-button-to-hit', rollHit);\n\t\thtml.on('click', '.mess-button-dmg', rollDmg);\n\n\t\t// delegate(html[0], {\n\t\t// \ttarget: '[data-tippy-content]'\n\t\t// });\n\t}\n\n\tHooks.on('preCreateChatMessage', async (data) => {\n\t\tconst div = document.createElement('div');\n\t\tdiv.insertAdjacentHTML('afterbegin',  data.content);\n\t\tlet btn = div.querySelector('button[data-action=\"attack\"]');\n\t\tif (!btn) {\n\t\t\tbtn = div.querySelector('button[data-action=\"damage\"]');\n\t\t}\n\t\tif (btn)\n\t\t\trenderAttack({currentTarget: btn});\n\n\t});\n\n\tHooks.on('renderItemSheet', itemHook)\n\n\tchangeAbilityTemplate();\n}\n"],"sourceRoot":""}