(window.webpackJsonp=window.webpackJsonp||[]).push([["modify-rolling"],{"./src/scripts/modify-rolling.js":
/*!***************************************!*\
  !*** ./src/scripts/modify-rolling.js ***!
  \***************************************/
/*! exports provided: default */function(e,t,a){"use strict";function s(){return game.settings.get("mess",game.userId+".adv-selector")}async function n(e){return"attack"===e.currentTarget.dataset.action||"damage"===e.currentTarget.dataset.action?d(e):e.currentTarget.dataset.placeTemplate?renderTemplate(e):this._onChatCardAction(e)}async function r({actor:e,item:t}){if(!t.hasAttack)return null;const a=e.data.data,s=t.data.data,n=e.data.flags.dnd5e||{};let r=t.getRollData();const o=["@mod"];("weapon"!==t.data.type||s.proficient)&&o.push("@prof"),r.parts=o,"weapon"===t.data.type&&n.weaponCriticalThreshold&&(r.critical=parseInt(n.weaponCriticalThreshold)),["weapon","spell"].includes(t.data.type)&&n.elvenAccuracy&&["dex","int","wis","cha"].includes(t.abilityMod)&&(r.elvenAccuracy=!0),n.halflingLucky&&(r.halflingLucky=!0);const l=a.bonuses[s.actionType]||{};(s.attackBonus||l.attack)&&(r.atk=[s.attackBonus,l.attack].filterJoin(" + "),isNaN(Number(r.atk))||o.push("@atk"));let i=new Roll(r.parts.join("+"),r);r.totalModifier=i._safeEval(i.formula),r.totalModifier=r.totalModifier>=0?"+"+r.totalModifier:r.totalModifier,r.atk&&!i._formula.includes("@atk")&&(r.parts.push("@atk"),i=new Roll(r.parts.join("+"),r),r.totalModifier+="+"+r.atk);const c=document.getElementById("mess-roll-mod");return c.value&&(r.parts.push(c.value),i=new Roll(r.parts.join("+"),r),r.totalModifier+="+"+c.value),r.formula=i.formula,r.terms=i._formula,r}async function o({actor:e,item:t,spellLevel:a=null}){if(!t.hasDamage)return null;const s=e.data.data,n=t.data.data;let r=t.getRollData();if(a&&(r.item.level=a),r.parts=duplicate(n.damage.parts),n.damage.versatile&&r.parts.splice(1,0,[n.damage.versatile,"versatile"]),"spell"===t.data.type)if("cantrip"===n.scaling.mode){let a=[r.parts[0][0]];const o="character"===e.data.type?s.details.level:s.details.spellLevel;t._scaleCantripDamage(a,o,n.scaling.formula),r.parts[0][0]=a[0]}else if(a&&"level"===n.scaling.mode&&n.scaling.formula){let e=[];t._scaleSpellDamage(e,n.level,a,n.scaling.formula),e.length>0&&(e.push("upcast dice"),r.parts.push(e))}const o=s.bonuses[n.actionType]||{};o.damage&&0!==parseInt(o.damage)&&(parts[0][0]+="+@dmg",r.dmg=o.damage);for(let e of r.parts){let t=new Roll(e[0],r);CONFIG.DND5E.damageTypes[e[1]]?e[1]=game.i18n.localize("DND5E.Damage"+CONFIG.DND5E.damageTypes[e[1]]):"versatile"===e[1]&&(e[1]=game.i18n.localize("DND5E.Versatile")),e.push(t.formula)}return r}async function l(e){const t=e.currentTarget;t.disabled=!0;const a=t.closest(".chat-card"),n=a.closest(".message").dataset.messageId;if(n){if(!game.messages.get(n).owner)return void ui.notifications.error("You do not own the permissions to make that rolL!")}const o=CONFIG.Item.entityClass._getChatCardActor(a);if(!o.owner)return!1;const l=o.getOwnedItem(a.dataset.itemId);if(!l)return ui.notifications.error(`The requested item ${a.dataset.itemId} no longer exists on Actor ${o.name}`);let i=await r({actor:o,item:l}),c=s(),d=1,u=i.halflingLucky?"r=1":"";"advantage"===c?(d=i.elvenAccuracy?3:2,u+="kh"):"disadvantage"===c&&(d=2,u+="kl"),i.parts.unshift(`${d}d20${u}`);let m=new Roll(i.parts.join("+"),i);m.roll();let g=document.createElement("div");g.title=`${i.parts[0]}+${i.terms} = ${m.formula} = ${m.total}. Click to see rolls.`,g.classList.add("dice-roll"),g.classList.add("mess-dice-result");const p=g.appendChild(document.createElement("span"));p.innerText=m.total,g.insertAdjacentHTML("beforeend",await m.getTooltip()),g.childNodes[1].classList.add("hidden");const f=i.critical||20,h=i.fumble||1,y=m.parts[0].total;if(y>=f&&(p.classList.add("crit"),a.querySelector(".mess-chat-dmg .mess-chat-roll-type").innerHTML+=" - Crit!",a.querySelectorAll(".mess-button-dmg").forEach((e,t)=>{const a=e.dataset.formula,s=new Roll(a);s.alter(0,2),e.innerHTML='<i class="fas fa-dice-d20"></i> '+s.formula,e.dataset.formula=s.formula})),y<=h&&p.classList.add("fumble"),e.currentTarget.parentNode.replaceChild(g,e.currentTarget),n){game.messages.get(n).update({content:a.parentNode.innerHTML})}}async function i(e){const t=e.currentTarget;t.disabled=!0;const a=t.closest(".chat-card"),s=a.closest(".message").dataset.messageId;if(s){if(!game.messages.get(s).owner)return void ui.notifications.error("You do not own the permissions to make that rolL!")}const n=t.dataset.formula;let r=new Roll(n);r.roll();let o=document.createElement("div");if(o.title=`${t.dataset.terms} = ${r.formula} = ${r.total}. Click to see rolls.`,o.classList.add("dice-roll"),o.classList.add("mess-dice-result"),o.appendChild(document.createElement("span")).innerText=r.total,o.insertAdjacentHTML("beforeend",await r.getTooltip()),o.childNodes[1].classList.add("hidden"),e.currentTarget.parentNode.replaceChild(o,e.currentTarget),s){game.messages.get(s).update({content:a.parentNode.innerHTML})}}async function c(e,t){let a=document.createElement("div");if(a.classList.add("message"),a.insertAdjacentHTML("afterbegin",t),e.hit){let e=a.querySelector(".mess-button-to-hit");e&&await l({currentTarget:e})}if(e.dmg){const e=Array.from(a.querySelectorAll(".mess-button-dmg"));for(const t of e)await i({currentTarget:t})}return a.innerHTML}async function d(e){"click"===e.type&&(e.preventDefault(),e.stopPropagation());const t=e.currentTarget;t.disabled=!0;const a=t.closest(".chat-card"),s=CONFIG.Item.entityClass._getChatCardActor(a);if(!s||!s.owner)return;const n=s.getOwnedItem(a.dataset.itemId);if(!n)return ui.notifications.error(`The requested item ${a.dataset.itemId} no longer exists on Actor ${s.name}`);let l=game.user.targets;const i=Object.keys(CONFIG.DND5E.areaTargetTypes).includes(getProperty(n,"data.data.target.type"));l.size&&!i||(l=[{data:{name:"someone",img:""}}]);const d=parseInt(a.dataset.spellLevel)||null,u={actor:s,item:n,toHit:await r({actor:s,item:n}),dmgs:await o({actor:s,item:n,spellLevel:d}),sceneId:canvas.scene.id,user:game.user.id},m=game.settings.get("mess",game.userId+".autoroll-selector");let g=game.settings.get("core","rollMode");for(const e of l){const t=await n._handleResourceConsumption({isCard:!1,isAttack:!0}),a={...u,target:e.data,flavor:n.data.data.chatFlavor.replace(/\[target\.name\]/g,e.data.name),allowed:t};let s=await renderTemplate("modules/mess/templates/attack-card.html",a);(m.hit||m.dmg)&&(s=await c(m,s));let r={user:game.user._id,type:CONST.CHAT_MESSAGE_TYPES.OTHER,content:s,speaker:{actor:n.actor._id,token:n.actor.token,alias:n.actor.name}};["gmroll","blindroll"].includes(g)&&(r.whisper=ChatMessage.getWhisperIDs("GM")),"blindroll"===g&&(r.blind=!0),ChatMessage.create(r)}t.disabled=!1}async function u(e){const t=e.currentTarget.closest(".mess-attack-card");if(t.dataset.sceneId!==canvas.scene.id)return!1;const a=t.dataset.targetId;if(!a)return!1;const s=canvas.tokens.placeables.find(e=>e.id===a);return s||!1}async function m(e){e.preventDefault(),e.stopPropagation();const t=await u(e);if(!t)return!1;t._onHoverIn()}async function g(e){e.preventDefault(),e.stopPropagation();const t=await u(e);if(!t||!t.visible)return!1;t._onHoverOut()}async function p(e){e.preventDefault(),e.stopPropagation();const t=await u(e);if(!t||!t.visible)return!1;const a=t.center;canvas.animatePan({x:a.x,y:a.y})}function f(e){const t=canvas.scene.data.grid,a=this.data.x,s=this.data.y,n=e.width>=1?.5:e.width/2,r=e.height>=1?.5:e.height/2;for(let o=n;o<e.width;o++)for(let n=r;n<e.height;n++){const r={x:e.x+o*t-a,y:e.y+n*t-s};if(this.shape.contains(r.x,r.y))return!0}return!1}function h(){const e=canvas.scene.getEmbeddedCollection("Token");let t=[];for(const a of e)this.isTokenInside(a)&&t.push(a._id);game.user.updateTokenTargets(t)}async function y(e,t){const a=document.createElement("div");a.classList.add("form-group"),a.appendChild(document.createElement("label")).innerText="Template Texture";const s=a.appendChild(document.createElement("div"));s.classList.add("form-fields");const n=s.appendChild(document.createElement("input"));n.dataset.dtype="String",n.type="text",n.name="flags.mess.templateTexture",n.value=e.object.getFlag("mess","templateTexture")||"",s.insertAdjacentHTML("beforeend",'\n\t\t<button type="button" class="file-picker" data-type="imagevideo" data-target="flags.mess.templateTexture" title="Browse Files" tabindex="-1">\n\t\t\t<i class="fas fa-file-import fa-fw"></i>\n\t\t</button>\n\t');const r=s.querySelector("button");r.style.flex="0",e._activateFilePicker(r),t[0].querySelector('[name="data.target.units"]').closest(".form-group").after(a)}async function b(e){let t=s(),a=1,n=e.halflingLucky?"r=1":"";"advantage"===t?(a=e.elvenAccuracy?3:2,n+="kh",e.title+=` (${game.i18n.localize("DND5E.Advantage")})`):"disadvantage"===t&&(a=2,n+="kl",e.title+=` (${game.i18n.localize("DND5E.Disadvantage")})`);let r=`${a}d20${n}`;e.reliableTalent&&(r=`{${a}d20${n},10}kh`),e.parts.unshift(r);const o=document.getElementById("mess-roll-mod").value;o&&e.parts.push(o);let l=new Roll(e.parts.join("+"),e);l.roll();const i=l.parts[0].total;let c={...e,tooltip:await l.getTooltip(),roll:l,crit:i>=20,fumble:i<=1};const d=await renderTemplate("modules/mess/templates/roll-card.html",c);let u={user:game.user._id,type:CONST.CHAT_MESSAGE_TYPES.OTHER,content:d,speaker:{actor:this,alias:this.name}},m=game.settings.get("core","rollMode");["gmroll","blindroll"].includes(m)&&(u.whisper=ChatMessage.getWhisperIDs("GM")),"blindroll"===m&&(u.blind=!0),ChatMessage.create(u)}async function v(e,t,a){const s=t[0].querySelectorAll(".ability-mod, .ability-name");$(s).off(),s.forEach(t=>t.addEventListener("click",(function(t){t.stopPropagation(),t.preventDefault();const a=t.currentTarget.closest(".ability").dataset.ability,s=CONFIG.DND5E.abilities[a],n=["@mod"],r={mod:e.object.data.data.abilities[a].mod},o=e.object.data.flags.dnd5e||{};o.remarkableAthlete&&DND5E.characterFlags.remarkableAthlete.abilities.includes(a)?(n.push("@proficiency"),r.proficiency=Math.ceil(.5*this.data.data.attributes.prof)):o.jackOfAllTrades&&(n.push("@proficiency"),r.proficiency=Math.floor(.5*this.data.data.attributes.prof));let l=getProperty(e.object.data.data.bonuses,"abilities.check");return l&&(n.push("@checkBonus"),r.checkBonus=l),r.parts=n,r.title=game.i18n.format("DND5E.AbilityPromptTitle",{ability:s}),b.bind(e.object)(r),!0}))),t[0].querySelectorAll(".ability-save").forEach(t=>t.addEventListener("click",(function(t){t.stopPropagation(),t.preventDefault();const a=t.currentTarget.closest(".ability").dataset.ability,s=CONFIG.DND5E.abilities[a],n=e.object.data.data.abilities[a],r=["@mod"],o={mod:n.mod};n.prof>0&&(r.push("@prof"),o.prof=n.prof);const l=getProperty(e.object.data.data.bonuses,"abilities.save");l&&(r.push("@saveBonus"),o.saveBonus=l),o.title=game.i18n.format("DND5E.SavePromptTitle",{ability:s}),o.parts=r,b.bind(e.object)(o)})));const n=t[0].querySelectorAll(".skill-name");$(n).off(),n.forEach(t=>t.addEventListener("click",(function(t){t.stopPropagation(),t.preventDefault();const a=t.currentTarget.closest(".skill").dataset.skill,s=e.object.data.data.skills[a],n=["@mod"],r={mod:s.mod+s.prof};s.bonus&&(r.skillBonus=s.bonus,n.push("@skillBonus"));s.value>=1&&e.object.getFlag("dnd5e","reliableTalent");return r.parts=n,r.title=game.i18n.format("DND5E.SkillPromptTitle",{skill:CONFIG.DND5E.skills[a]}),b.bind(e.object)(r),!1})))}async function T(){game.settings.register("mess",game.userId+".adv-selector",{name:"Mess - Advantage Selector",default:"normal",type:String,scope:"user"}),game.settings.register("mess",game.userId+".autoroll-selector",{name:"Mess - Autoroll Selector",default:{hit:!1,dmg:!1},type:Object,scope:"user"}),Hooks.on("renderChatLog",async(e,t,a)=>{const s=await async function(){const e=document.createElement("div");e.classList.add("mess-roll-control");const t=game.settings.get("mess",game.userId+".adv-selector"),a={advantage:"advantage"===t,normal:"normal"===t,disadvantage:"disadvantage"===t,...game.settings.get("mess",game.userId+".autoroll-selector")};return e.insertAdjacentHTML("afterbegin",await renderTemplate("modules/mess/templates/roll-control.html",a)),e.querySelectorAll(".mess-adv-selector a").forEach(e=>{e.addEventListener("click",(async function(e){e.preventDefault(),e.stopPropagation();const t=Array.from(e.currentTarget.parentNode.querySelectorAll("a")),a=t.findIndex(e=>e.classList.contains("mess-selected"));t[a].classList.remove("mess-selected");const s=t[(a+1)%t.length];s.classList.add("mess-selected"),game.settings.set("mess",game.userId+".adv-selector",s.name)}))}),e.querySelectorAll(".mess-autoroll-selector a").forEach(e=>{e.addEventListener("click",(async function(e){e.preventDefault(),e.stopPropagation(),e.currentTarget.classList.toggle("mess-selected");let t=game.settings.get("mess",game.userId+".autoroll-selector");t[e.currentTarget.name]=e.currentTarget.classList.contains("mess-selected"),game.settings.set("mess",game.userId+".autoroll-selector",t)}))}),e}(),n=t[0].querySelector("#chat-controls");n.insertBefore(s,n.childNodes[0])}),CONFIG.Item.entityClass.chatListeners=function(e){e.on("click",".card-buttons button",n.bind(this)),e.on("click",".item-name",this._onChatCardToggleContent.bind(this)),e.on("mouseenter",".mess-chat-target",m),e.on("mouseleave",".mess-chat-target",g),e.on("dblclick",".mess-chat-target",p),e.on("click",".mess-button-to-hit",l),e.on("click",".mess-button-dmg",i)},Hooks.on("preCreateChatMessage",async e=>{const t=document.createElement("div");t.insertAdjacentHTML("afterbegin",e.content);let a=t.querySelector('button[data-action="attack"]');a||(a=t.querySelector('button[data-action="damage"]')),a&&d({currentTarget:a})}),Hooks.on("renderItemSheet",y),Hooks.on("renderActorSheet",v),async function(){const e=await import("/systems/dnd5e/module/pixi/ability-template.js"),t=e.default||e.AbilityTemplate,a=t.fromItem;t.fromItem=function(e){const t=a.bind(this)(e);let s=e.getFlag("mess","templateTexture");if(!s&&e.hasDamage){const a=game.settings.get("mess","templateTexture")||{};s=a[e.data.data.damage.parts[0][1]]||{},s=s[t.data.t]}return s&&loadTexture(s).then(e=>{t.texture=e,t.data.texture=s,t.refresh()}),t.item=e,t};const s=t.prototype.activatePreviewListeners.toString().replace(/this\.refresh\(\)\;/,"this.refresh();\n\t\t\t\t\tthis.getTargets(this);\n\t\t\t\t");t.prototype.getTargets=h,t.prototype.isTokenInside=f,t.prototype.activatePreviewListeners=Function(`"use strict"; return ( function ${s} )`)()}()}a.r(t),a.d(t,"default",(function(){return T}))}}]);
//# sourceMappingURL=modify-rolling.df14.js.map