{"version":3,"sources":["webpack:///webpack/bootstrap","webpack:///./src/scripts/actor-item-sort-btn.js","webpack:///./src/scripts/add-scrolling.js","webpack:///./src/scripts/change-placeables.js","webpack:///./src/scripts/chat-popup/index.js","webpack:///./src/scripts/draggable-lists/draggable-list.js","webpack:///./src/scripts/draggable-lists/index.js","webpack:///./src/scripts/index.js","webpack:///./src/scripts/modify-templates.js","webpack:///./src/scripts/prepared-spell-tracker.js","webpack:///./src/scripts/rolls/apply-dmg.js","webpack:///./src/scripts/rolls/controls.js","webpack:///./src/scripts/rolls/dice.js","webpack:///./src/scripts/rolls/index.js","webpack:///./src/scripts/rolls/modify-rolling.js","webpack:///./src/scripts/rolls/util.js","webpack:///./src/scripts/settings.js"],"names":["webpackJsonpCallback","data","moduleId","chunkId","chunkIds","moreModules","i","resolves","length","Object","prototype","hasOwnProperty","call","installedChunks","push","modules","parentJsonpFunction","shift","installedModules","__webpack_require__","exports","module","l","e","promises","installedChunkData","promise","Promise","resolve","reject","onScriptComplete","script","document","createElement","charset","timeout","nc","setAttribute","src","p","jsonpScriptSrc","error","Error","event","onerror","onload","clearTimeout","chunk","errorType","type","realSrc","target","message","name","request","undefined","setTimeout","head","appendChild","all","m","c","d","getter","o","defineProperty","enumerable","get","r","Symbol","toStringTag","value","t","mode","__esModule","ns","create","key","bind","n","object","property","oe","err","console","jsonpArray","window","oldJsonpFunction","slice","s","async","addAlphabeticalSorter","app","html","actor","_id","querySelectorAll","forEach","el","closest","dataset","tab","btn","innerHTML","classList","add","title","style","flex","margin","addEventListener","ev","lists","actorId","fromUuid","concatList","map","items","spells","flat","sort","a","b","siblings","sortUpdates","SortingHelpers","performIntegerSort","duplicate","sortBefore","updateData","u","update","updateEmbeddedEntity","sortItemListAlphabetically","prepend","itemSortBtn","Hooks","on","addScolling","preventDefault","stopPropagation","deltaY","currentTarget","Number","Math","max","$","change","onDragLeftMove","clones","destination","origin","originalEvent","canvas","_onDragCanvasPan","dx","x","dy","y","snap","previous","momentumThreshold","lambda","prev","prevMomentum","momentum","prevV","v","shiftKey","dest","_original","grid","getSnappedPosition","this","layer","options","gridPrecision","refresh","changePlaceables","PlaceableObject","_onDragLeftMove","initChatPopUp","getElementById","contains","log","DraggableList","container","selector","mergeObject","defaultOptions","_init","offset","time","dir","onDragStart","onDragEnd","onDrop","_items","Array","from","rect","getBoundingClientRect","insideChild","clientY","height","clientX","width","_resetOffsets","idx","_initItem","position","_onDragEnterItem","_onDragLeaveItem","matches","headerRect","top","bottom","TweenLite","to","paddingTop","_over","item","timeEnd","initDraggableLists","oldFun","SidebarDirectory","activateListeners","list","querySelector","SceneDirectory","_onLazyLoadImage","entries","observer","isIntersecting","li","backgroundImage","children","img","unobserve","game","settings","CONFIG","debug","mess","sheet","render","user","isGM","moduleVersion","version","register","default","String","scope","oldVersion","isNewerVersion","init","changeTemplates","newFun","MeasuredTemplate","toString","replace","Function","getTargets","isTokenInside","ret","dndTemplateSettings","system","id","importedJS","import","AbilityTemplate","itemHook","_originalFromItem","fromItem","template","path","getFlag","hasDamage","damage","parts","loadTexture","then","tex","texture","activatePreviewListeners","token","scene","templatePos","startX","startY","currGrid","shape","tokens","getEmbeddedCollection","targets","updateTokenTargets","div","innerText","i18n","localize","formField","inp","dtype","insertAdjacentHTML","button","_activateFilePicker","after","addPreparedSpellTracker","isNPC","tracker","border","preparedSpells","sep","val","isNaN","setFlag","constructor","alignSelf","parentNode","insertBefore","getAllDmg","reduce","getAllVersatile","resultArray","splice","modifyApplyDmg","canApply","canApplyNonVersatile","canApplyVersatile","hasTarget","targetId","hasNoTarget","contextOptionsDmg","condition","icon","callback","applyDamage","content","floor","contextOptionsRoll","ContextMenu","MessContextMenu","find","setProperty","controlled","args","super","_menuItems","menuItems","filteredItems","filter","ol","frag","createDocumentFragment","join","close","_setPosition","_animateOpen","removeClass","sign","amount","card","sceneId","scenes","ui","notifications","Token","getEmbeddedEntity","owner","chatLogHook","advSelector","userId","templateData","advantage","normal","disadvantage","renderTemplate","arr","currIdx","findIndex","remove","newSelected","set","toggle","controls","childNodes","hit","dmg","getD20Modifier","getAdvantageSettings","rollD20","adv","nd","mods","halflingLucky","elvenAccuracy","diceFormula","reliableTalent","unshift","d20Mod","Roll","roll","d20","total","tooltip","getTooltip","crit","fumble","chatData","CONST","CHAT_MESSAGE_TYPES","OTHER","speaker","alias","rollMode","includes","ChatMessage","getWhisperIDs","diceSoNice","whispers","blind","dice3d","showForRoll","getToHitData","hasAttack","actorData","itemData","flags","dnd5e","rollData","getRollData","proficient","weaponCriticalThreshold","critical","parseInt","abilityMod","actorBonus","bonuses","actionType","attackBonus","attack","filterJoin","totalModifier","_safeEval","formula","_formula","situationalModifier","terms","rollToHit","disabled","messageId","messages","isAuthor","Item","entityClass","_getChatCardActor","getOwnedItem","itemId","span","customTooltip","split","dataTerms","term","num","rgx","RegExp","Die","die","match","updateMessage","replaceChild","getDmgData","spellLevel","level","versatile","itm","bnsDmgParts","itmData","lbl","DND5E","damageTypes","scaling","newDmgPart","lvl","details","_scaleCantripDamage","_scaleSpellDamage","part","_evalParentheticalTerms","rollDmg","contextMenu","nextElementSibling","AudioHelper","play","sounds","dice","rolling","toggleItemBonusDamage","itemName","getSpeaker","actors","warn","newState","preCreateChatMessageHook","renderAttack","getFlavor","chatFlavor","rollTables","matchAll","collection","tables","tableData","table","entities","result","results","text","areaSkill","keys","areaTargetTypes","getProperty","size","attackData","toHit","dmgs","autoroll","allowed","_handleResourceConsumption","isCard","isAttack","targetActor","targetData","ac","label","attributes","di","traits","toUpperCase","substring","custom","dr","dv","attackTemplateData","flavor","autoRoll","whisper","getWhisperRecipients","dsn","rolls","toHitBtn","btns","actorSheetHook","abilityMods","off","abilityId","ability","abilities","mod","feats","remarkableAthlete","characterFlags","ceil","prof","jackOfAllTrades","checkBonus","format","saveMods","abl","saveBonus","skills","skillId","skill","skl","bonus","chatListeners","onChatCardAction","_onChatCardToggleContent","onMouseEnterTarget","onMouseLeaveTarget","onDblClickTarget","onToggleShowPlayers","action","placeTemplate","_onChatCardAction","getTargetToken","_onHoverIn","visible","_onHoverOut","pos","center","animatePan","tokenId","placeables","checked","oldGetTooltip","once","MessSettings","FormApplication","isDnD","hint","config","Boolean","registerMenu","restricted","loadTemplates","classes","tabs","navSelector","contentSelector","initial","submitOnClose","_getHeaderButtons","getData","dmgTypes","templateTypes","types","getSettingsData","formData","expandObject","Dialog","buttons","yes","location","reload","no"],"mappings":"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","file":"index.js","sourcesContent":[" \t// install a JSONP callback for chunk loading\n \tfunction webpackJsonpCallback(data) {\n \t\tvar chunkIds = data[0];\n \t\tvar moreModules = data[1];\n\n\n \t\t// add \"moreModules\" to the modules object,\n \t\t// then flag all \"chunkIds\" as loaded and fire callback\n \t\tvar moduleId, chunkId, i = 0, resolves = [];\n \t\tfor(;i < chunkIds.length; i++) {\n \t\t\tchunkId = chunkIds[i];\n \t\t\tif(Object.prototype.hasOwnProperty.call(installedChunks, chunkId) && installedChunks[chunkId]) {\n \t\t\t\tresolves.push(installedChunks[chunkId][0]);\n \t\t\t}\n \t\t\tinstalledChunks[chunkId] = 0;\n \t\t}\n \t\tfor(moduleId in moreModules) {\n \t\t\tif(Object.prototype.hasOwnProperty.call(moreModules, moduleId)) {\n \t\t\t\tmodules[moduleId] = moreModules[moduleId];\n \t\t\t}\n \t\t}\n \t\tif(parentJsonpFunction) parentJsonpFunction(data);\n\n \t\twhile(resolves.length) {\n \t\t\tresolves.shift()();\n \t\t}\n\n \t};\n\n\n \t// The module cache\n \tvar installedModules = {};\n\n \t// object to store loaded and loading chunks\n \t// undefined = chunk not loaded, null = chunk preloaded/prefetched\n \t// Promise = chunk loading, 0 = chunk loaded\n \tvar installedChunks = {\n \t\t\"index\": 0\n \t};\n\n\n\n \t// script path function\n \tfunction jsonpScriptSrc(chunkId) {\n \t\treturn __webpack_require__.p + \"bundles/\" + ({\"welcome-screen\":\"welcome-screen\"}[chunkId]||chunkId) + \".\" + {\"welcome-screen\":\"89ea\"}[chunkId] + \".js\"\n \t}\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n \t// This file contains only the entry chunk.\n \t// The chunk loading function for additional chunks\n \t__webpack_require__.e = function requireEnsure(chunkId) {\n \t\tvar promises = [];\n\n\n \t\t// JSONP chunk loading for javascript\n\n \t\tvar installedChunkData = installedChunks[chunkId];\n \t\tif(installedChunkData !== 0) { // 0 means \"already installed\".\n\n \t\t\t// a Promise means \"currently loading\".\n \t\t\tif(installedChunkData) {\n \t\t\t\tpromises.push(installedChunkData[2]);\n \t\t\t} else {\n \t\t\t\t// setup Promise in chunk cache\n \t\t\t\tvar promise = new Promise(function(resolve, reject) {\n \t\t\t\t\tinstalledChunkData = installedChunks[chunkId] = [resolve, reject];\n \t\t\t\t});\n \t\t\t\tpromises.push(installedChunkData[2] = promise);\n\n \t\t\t\t// start chunk loading\n \t\t\t\tvar script = document.createElement('script');\n \t\t\t\tvar onScriptComplete;\n\n \t\t\t\tscript.charset = 'utf-8';\n \t\t\t\tscript.timeout = 120;\n \t\t\t\tif (__webpack_require__.nc) {\n \t\t\t\t\tscript.setAttribute(\"nonce\", __webpack_require__.nc);\n \t\t\t\t}\n \t\t\t\tscript.src = jsonpScriptSrc(chunkId);\n\n \t\t\t\t// create error before stack unwound to get useful stacktrace later\n \t\t\t\tvar error = new Error();\n \t\t\t\tonScriptComplete = function (event) {\n \t\t\t\t\t// avoid mem leaks in IE.\n \t\t\t\t\tscript.onerror = script.onload = null;\n \t\t\t\t\tclearTimeout(timeout);\n \t\t\t\t\tvar chunk = installedChunks[chunkId];\n \t\t\t\t\tif(chunk !== 0) {\n \t\t\t\t\t\tif(chunk) {\n \t\t\t\t\t\t\tvar errorType = event && (event.type === 'load' ? 'missing' : event.type);\n \t\t\t\t\t\t\tvar realSrc = event && event.target && event.target.src;\n \t\t\t\t\t\t\terror.message = 'Loading chunk ' + chunkId + ' failed.\\n(' + errorType + ': ' + realSrc + ')';\n \t\t\t\t\t\t\terror.name = 'ChunkLoadError';\n \t\t\t\t\t\t\terror.type = errorType;\n \t\t\t\t\t\t\terror.request = realSrc;\n \t\t\t\t\t\t\tchunk[1](error);\n \t\t\t\t\t\t}\n \t\t\t\t\t\tinstalledChunks[chunkId] = undefined;\n \t\t\t\t\t}\n \t\t\t\t};\n \t\t\t\tvar timeout = setTimeout(function(){\n \t\t\t\t\tonScriptComplete({ type: 'timeout', target: script });\n \t\t\t\t}, 120000);\n \t\t\t\tscript.onerror = script.onload = onScriptComplete;\n \t\t\t\tdocument.head.appendChild(script);\n \t\t\t}\n \t\t}\n \t\treturn Promise.all(promises);\n \t};\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"modules/mess/scripts/\";\n\n \t// on error function for async loading\n \t__webpack_require__.oe = function(err) { console.error(err); throw err; };\n\n \tvar jsonpArray = window[\"webpackJsonp\"] = window[\"webpackJsonp\"] || [];\n \tvar oldJsonpFunction = jsonpArray.push.bind(jsonpArray);\n \tjsonpArray.push = webpackJsonpCallback;\n \tjsonpArray = jsonpArray.slice();\n \tfor(var i = 0; i < jsonpArray.length; i++) webpackJsonpCallback(jsonpArray[i]);\n \tvar parentJsonpFunction = oldJsonpFunction;\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = \"./src/scripts/index.js\");\n","async function sortItemListAlphabetically(lists, actorId) {\n\tconst actor = await fromUuid(`Actor.${actorId}`);\n\tlet concatList = lists.map(e => e.items || e.spells).flat();\n\tconcatList.sort(function (a, b) {\n\t\tif (a.name < b.name) return -1;\n\t\tif (a.name > b.name) return 1;\n\t\treturn 0;\n\t});\n\tlet siblings = [concatList.shift()];\n\tlet sortUpdates = [];\n\tfor (; concatList.length > 0; siblings.push(concatList.shift())) {\n\t\tsortUpdates = (SortingHelpers.performIntegerSort(concatList[0], {\n\t\t\ttarget: siblings[siblings.length-1], \n\t\t\tsiblings: duplicate(siblings),\n\t\t\tsortBefore: false}));\t\t\n\t}\n\tconst updateData = sortUpdates.map(u => {\n\t\tlet update = u.update;\n\t\tupdate._id = u.target._id;\n\t\treturn update;\n\t})\n\tactor.updateEmbeddedEntity('OwnedItem', updateData);\n}\n\nasync function addAlphabeticalSorter(app, html, data) {\n\tif (!data.actor._id) return;\n\tconst header = html.querySelectorAll('.filter-list');\n\n\theader.forEach(el => {\n\t\tconst type = el.closest('.tab').dataset.tab;\n\t\tconst btn = document.createElement('a');\n\t\tbtn.innerHTML = '<i class=\"fas fa-sort\"></i>';\n\t\tbtn.classList.add('mess-sort-btn');\n\t\tbtn.title = `Sort ${type} alphabetically.`;\n\t\tbtn.style.flex = 0;\n\t\tbtn.style.margin = \"0 5px 0 0\";\n\t\tbtn.addEventListener('click',\t(ev) => sortItemListAlphabetically(data[type], data.actor._id))\n\t\tel.prepend(btn);\n\t});\n}\n\nexport default async function itemSortBtn() {\n\tHooks.on('renderActorSheet', (app, html, data) => {\n\t\taddAlphabeticalSorter(app, html[0], data);\n\t});\n}","export default async function addScolling() {\n\tHooks.on('renderActorSheet', async function (app,  html, data) {\n\t\thtml[0].querySelectorAll('input[data-dtype=\"Number\"], .item-uses input').forEach(el => {\n\t\t\tel.addEventListener('wheel', ev => {\n\t\t\t\tev.preventDefault();\n\t\t\t\tev.stopPropagation();\n\t\t\t\tif (ev.deltaY < 0)\n\t\t\t\t\tev.currentTarget.value = Number(ev.currentTarget.value) + 1;\n\t\t\t\tif (ev.deltaY > 0)\n\t\t\t\t\tev.currentTarget.value = Math.max(Number(ev.currentTarget.value) - 1, 0);\n\n\t\t\t\t$(ev.currentTarget).change()\n\t\t\t});\n\t\t})\n\t});\n}","function onDragLeftMove(event) {\n\tconst {clones, destination, origin, originalEvent} = event.data;\n\n\t// Pan the canvas if the drag event approaches the edge\n\tcanvas._onDragCanvasPan(originalEvent);\n\n\t// Determine dragged distance\n\tconst dx = destination.x - origin.x;\n\tconst dy = destination.y - origin.y;\n\n\tlet snap = false;\n\tif (event.data.previous) {\n\t\t// Interesting would be here how this all behaves for different monitor sizes/performances and when Atro possibly introduces more adaptive rates for mosue movement. \n\t\t// Why? Because currently i just set the timedifferences between function calls to 1. So for 60Hz it behaves same as 30Hz although for 30Hz the distance travelled could be bigger.\n\t\t// All this because i don't want divisions in here for the moment....\n\t\tconst momentumThreshold = 30;\n\t\t// smaller lambda means less \"memory\" => current momentum does have more impact\n\t\t// => more jumping around between snapping and not\n\t\t// but higher means more waiting/slow movement time for it to snap\n\t\tconst lambda = 0.8;\n\t\tconst prev = event.data.previous;\n\t\tconst prevMomentum = event.data.momentum || 0;\n\t\tconst prevV = event.data.v || {x: 0, y: 0};\n\t\tconst v = {\n\t\t\tx: destination.x - prev.x,\n\t\t\ty: destination.y - prev.y\n\t\t}\n\t\tconst momentum = {\n\t\t\tx: v.x - prevV.x,\n\t\t\ty: v.y - prevV.y\n\t\t};\n\n\t\tevent.data.momentum = (momentum.x * momentum.x + momentum.y * momentum.y) + prevMomentum * lambda;\n\t\tsnap = !event.shiftKey && event.data.momentum < momentumThreshold;\n\t}\n\n\tevent.data.previous = destination;\n\n\t// Update the position of each clone\n\tfor ( let c of clones || [] ) {\n\t\tlet dest = {x: c._original.data.x + dx, y: c._original.data.y + dy};\n\t\tif ( snap ) {\n\t\t\tdest = canvas.grid.getSnappedPosition(dest.x, dest.y, this.layer.options.gridPrecision);\n\t\t}\n\t\tc.data.x = dest.x;\n\t\tc.data.y = dest.y;\n\t\tc.refresh();\n\t}\n}\n\nexport function changePlaceables() {\n\tPlaceableObject.prototype._onDragLeftMove = onDragLeftMove;\n\t// Change got bigger than expected, so.. complete swap it is\n}","export function initChatPopUp() {\n\tHooks.on('renderChatMessage', (app, html, options) => {\n\t\tif (document.getElementById('chat').classList.contains('active')) return;\n\n\n\t\tconsole.log('rendering chat message');\n\t\tconsole.log(app, html, options);\n\t\tconsole.log(document.getElementById('chat').classList.contains('active'))\n\t});\n\n\tconst hud = document.getElementById('hud');\n\n\tlet popupDiv = hud.appendChild(document.createElement('div'));\n\tpopupDiv.classList.add('mess-chat-popup')\n}","export class DraggableList {\n\tconstructor(container, selector, options = {}) {\n\t\tthis.container = container;\n\t\tthis.selector = selector;\n\t\tthis.options = mergeObject(this.defaultOptions, options);\n\n\t\tthis._init();\n\t}\n\t\n\tget defaultOptions() {\n\t\treturn {\n\t\t\toffset: 21, // in px\n\t\t\ttime: 0.2, // in seconds\n\t\t\tdir: null, // this selector will not get offset when hovered over\n\t\t\t// folowing are not used\n\t\t\tonDragStart: null,\n\t\t\tonDragEnd: null,\n\t\t\tonDrop: null,\n\t\t\t\n\t\t}\n\t}\n\n\tasync _init() {\n\t\t// this._items = Array.from(this.container.childNodes).filter(e => e.matches && e.matches(this.selector));\n\t\tthis._items = Array.from(this.container.querySelectorAll(this.selector));\n\t\tthis.container.addEventListener('dragleave', ev => {\n\t\t\tconst rect = this.container.getBoundingClientRect();\n\t\t\tconst boundary = 5;\n\t\t\t//  Reset offsets, when first target was inside a child container.\n\t\t\tconst insideChild = ev.insideChild;\n\t\t\tif (!insideChild \n\t\t\t\t\t&& ev.clientY < rect.y + rect.height - boundary\n\t\t\t\t\t&& ev.clientY > rect.y + boundary\n\t\t\t\t\t&& ev.clientX > rect.x + boundary \n\t\t\t\t\t&& ev.clientX < rect.x -  boundary + rect.width) {\n\t\t\t\t\t\tev.insideChild = true;\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\tthis._resetOffsets();\n\t\t});\n\n  /**  Possibly modifying the drop target.\n\t * Why?\n\t * Due to the method used, the target gets moved out of the way and it will automatically drop onto the container element.\n\t * Most drop functions in fvtt just append to the end though, when dropping onto the container.\n\t * => We search for the first offset element and define that one as target. Since default for sorting is \"insertBefore\", and most implementations i've found build upon FVTT default/dnd5e systems default, this is a rather save implementation to find the real target.\n\t */\n\t\tthis.container.addEventListener('drop', ev => {\n\t\t\t// const insideChild = ev.insideChild;\n\t\t\t// if (this._over) {\n\t\t\t// \tObject.defineProperty(ev, 'target', {writable: false, value: this._over})\n\t\t\t// \t// Make sure that outer directories are not overwriting this stuff!\n\t\t\t// \t// ev.insideChild = true;\n\t\t\t// }\n\t\t});\n\t\tthis._items.forEach((e, idx) => this._initItem(e, idx))\n\t}\n\n\tasync _initItem(el, idx) {\n\t\tel.style.position = \"relative\";\n\t\tel.addEventListener('dragenter', ev => this._onDragEnterItem(ev, idx));\n\t\tel.addEventListener('dragleave', ev => this._onDragLeaveItem(ev, idx));\n\t\tel.addEventListener('dragend', ev => {\n\t\t\t// safety net if for some reasons the rerender is to slow or fails...\n\t\t\t// const srcElement = ev.currentTarget;\n\t\t\t// srcElement.style.opacity = null;\n\t\t\t// srcElement.style.height = null;\n\t\t\t// TweenLite.from(srcElement, this.options.time, {opacity:0, height:0});\n\t\t\tthis._resetOffsets();\n\t\t});\n\t\t// el.addEventListener('dragstart', ev => {\n\t\t// \tthis._dragged = ev.currentTarget;\n\t\t// \t// if (ev.currentTarget.matches(this.dir))\n\t\t// \t// \tthis._draggingDir = true;\n\t\t// \t// else \n\t\t// \t// \tthis._draggingDir = false;\n\t\t// \t// TweenLite.to(ev.currentTarget, this.options.time, {opacity: 0, height: 0});\n\t\t// })\n\t}\n\n\t_onDragEnterItem(ev, idx) {\n\t\tconsole.time('dragEnter')\n\t\tev.stopPropagation();\n\n\t\t// // save the current target\n\t\tconst time = this.options.time;\n\t\tconst offset = this.options.offset;\n\t\tthis._resetOffsets();\n\t\tlet target = ev.currentTarget;\n\t\tconsole.log(ev.currentTarget)\n\t\t// if inside a container, just make sure that its not jumping around. (Sometimes its ignoring the real target...)\n\t\tif (target.matches(this.options.dir)) {\n\t\t\tconst items = Array.from(target.querySelectorAll(this.selector));\n\t\t\tconst headerRect = target.getBoundingClientRect();\n\t\t\tif (ev.clientY > headerRect.top && ev.clientY < headerRect.bottom) {\n\t\t\t\tTweenLite.to(items, time, {paddingTop: 0});\n\t\t\t\tthis._over = target;\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tfor (let item of items) {\n\t\t\t\tconst rect = item.getBoundingClientRect();\n\t\t\t\tif (rect.bottom > ev.clientY) {\n\t\t\t\t\ttarget = item;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tthis._over = target;\n\t\tconsole.log(target, offset);\n\t\tTweenLite.to(target, time, {paddingTop: offset});\n\t\t// let resetList = [];\n\t\t// let offsetList = [];\n\t\t// let prev = item.previousElementSibling;\n\t\t// while (prev) {\n\t\t// \t// TweenLite.to(prev, time, {top: 0})\n\t\t// \tresetList.push(prev);\n\t\t// \tprev = prev.previousElementSibling;\n\t\t// }\n\t\t// let next = item;\n\t\t// while (next) {\n\t\t// \tif (!this._draggingDir && next.matches(this.options.dir)) {\n\t\t// \t\t// TweenLite.to(next, time, {top: 0});\n\t\t// \t\tresetList.push(next);\n\t\t// \t} else\n\t\t// \t\toffsetList.push(next);\n\t\t// \t\t// TweenLite.to(next, time, {top: offset});\n\t\t// \tnext = next.nextElementSibling;\n\t\t// }\n\n\t\t// // // if (ev.currentTarget.matches(this.options.dir)) {\n\t\t\t\n\t\t// // // \tidx = idx + 1;\n\t\t// // // }\n\t\t// // // for (let i = idx; i < this._items.length; i++) {\n\t\t// // // \tconst rect = this._items[i].getBoundingClientRect();\n\t\t// // // }\n\t\t// // const resetList = this._items.slice(0, idx);\n\t\t// TweenLite.to(resetList, time, {top: 0});\n\t\t// // const offsetList = this._items.slice(idx);\n\t\t// TweenLite.to(offsetList, time, {top: offset});\n\n\t\tconsole.timeEnd('dragEnter')\n\t\treturn false;\n\t}\n\n\n\t_onDragLeaveItem(ev, idx) {\n\t\t// console.time('dragLeave')\n\t\tev.stopPropagation();\n\t\treturn false;\n\t\t// // Empty for now?\n\n\t\t// TweenLite.to(ev.currentTarget, 0.3, {transform: \"scale(1, 1)\"});\n\t\t// console.timeEnd('dragLeave')\n\t}\n\n\t// We now work with padding, cause.. reasons..\n\t_resetOffsets(time = this.options.time) {\n\t\t// TweenLite.to(this._items, time, {top: 0});\n\t\tTweenLite.to(this._items, time, {paddingTop: 0});\n\t}\n}\n","import {DraggableList} from './draggable-list';\n\nexport function initDraggableLists() {\n   // make sure my listeners to get bound _before_ the class owns get bound to the elements\n  // Only needed for the \"root\" directory though.. :/\n  const oldFun = SidebarDirectory.prototype.activateListeners;\n  SidebarDirectory.prototype.activateListeners = function(html) {\n    // const list = html[0].querySelectorAll('.directory-list, .directory-item');\n    // list.forEach(e => new DraggableList(e, '.entity'));\n    const list = html[0].querySelector('.directory-list');\n    new DraggableList(list, '.entity, .folder', {dir: '.folder'});\n    oldFun.call(this, html);\n  }\n\n  // this does work, since on default most sheets have their drop function bound to the form, not the item list!\n  Hooks.on('renderActorSheet', (app, html, options) => {\n    const list = html[0].querySelectorAll('.item-list');\n    list.forEach(e => new DraggableList(e, '.item'));\n  });\n\n  SceneDirectory.prototype._onLazyLoadImage = function(entries, observer) {\n    for ( let e of entries ) {\n      if ( !e.isIntersecting ) continue;\n      const li = e.target;\n\n      // Background Image\n      if ( li.dataset.backgroundImage ) {\n        li.children[0].style[\"background-image\"] = `url(\"${li.dataset.backgroundImage}\")`;\n        delete li.dataset.backgroundImage;\n      }\n\n      // Avatar image\n      const img = li.querySelector(\"img\");\n      if ( img && img.dataset.src ) {\n        img.src = img.dataset.src;\n        delete img.dataset.src;\n      }\n\n      // No longer observe the target\n      observer.unobserve(e.target);\n    }\n  }\n}","import { rolling } from './rolls';\nimport { MessSettings } from './settings.js';\nimport {dndTemplateSettings, changeTemplates } from './modify-templates.js';\nimport { changePlaceables } from './change-placeables.js';\nimport itemSortBtn from './actor-item-sort-btn.js';\nimport preparedSpellTracker from './prepared-spell-tracker.js';\nimport addScrolling from './add-scrolling.js';\n\nimport {initDraggableLists} from './draggable-lists';\nimport {initChatPopUp} from './chat-popup';\n\nHooks.on('ready', async function() {\n\tif (game.settings.get('mess', 'actor-item-sort'))\n\t\titemSortBtn();\n\tif (game.settings.get('mess', 'prepared-spell-tracker'))\n\t\tpreparedSpellTracker();\n\tif (game.settings.get('mess', 'add-scrolling'))\n\t\taddScrolling();\n\t\n\tif (CONFIG.debug.mess) {\n\t\tconst actor = (await fromUuid('Actor.xV3LUAg05Pz5MFTS'));\n\t\tactor.sheet.render(true);\n\t}\n\n\t// initChatPopUp();\n\n\tif (!game.user.isGM)\n\treturn;\n\t// Edit next line to match module.\n\tconst module = game.modules.get(\"mess\");\n\tconst title = module.data.title;\n\tconst moduleVersion = module.data.version;\n\tgame.settings.register(title, 'version', {\n\t\tname: `${title} Version`,\n\t\tdefault: \"0.0.0\",\n\t\ttype: String,\n\t\tscope: 'world',\n\t});\n\tconst oldVersion = game.settings.get(title, \"version\");\n\n\tif (!isNewerVersion(moduleVersion, oldVersion))\n\t\treturn;\n\n\t(await import(\n\t\t\t\t\t\t\t\t/* webpackChunkName: \"welcome-screen\" */\n\t\t\t\t\t\t\t\t'./welcome-screen.js'\n\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t).default();\n});\n\nHooks.on('init', function() {\n\tgame.mess = {};\n\tCONFIG.debug.mess = false;\n\tMessSettings.init();\n\n\trolling();\n\n\tdndTemplateSettings();\n\tchangeTemplates();\n\tif (game.settings.get('mess', 'change-placeables'))\n\t\tchangePlaceables();\n\tif (game.settings.get('mess', 'better-draggable-lists'))\n\t\tinitDraggableLists();\n});\n","export function changeTemplates() {\n\n  // #MonkeyPatchingFTW\n  // better than stealing the code, replacing one line and then release it under a/the wrong license..\n  // Disadvantage: could need more fixing on updates. At least i didn#t make it line based like Kakaroto.. :P\n  \n\tlet newFun = MeasuredTemplate.prototype.refresh.toString();\n\n\tif (game.settings.get('mess', 'modify-templates')) {\n\t\tnewFun = newFun.replace(/this\\.template\\.beginTextureFill\\(\\{[\\s\\S]*\\}\\)\\;/, `\n\t\t\t{\n\t\t\t\tlet mat = PIXI.Matrix.IDENTITY;\n\t\t\t\t// rectangle\n\t\t\t\tif (this.shape.width && this.shape.height)\n\t\t\t\t\tmat.scale(this.shape.width / this.texture.width, this.shape.height / this.texture.height);\n\t\t\t\telse if (this.shape.radius) {\n\t\t\t\t\tmat.scale(this.shape.radius * 2 / this.texture.height, this.shape.radius * 2 / this.texture.width)\n\t\t\t\t\t// Circle center is texture start...\n\t\t\t\t\tmat.translate(-this.shape.radius, -this.shape.radius);\n\t\t\t\t} else if (this.data.t === \"ray\") {\n\t\t\t\t\tconst d = canvas.dimensions,\n\t\t\t\t\t\t\t\theight = this.data.width * d.size / d.distance,\n\t\t\t\t\t\t\t\twidth = this.data.distance * d.size / d.distance;\n\t\t\t\t\tmat.scale(width / this.texture.width, height / this.texture.height);\n\t\t\t\t\tmat.translate(0, -height * 0.5);\n\n\t\t\t\t\tmat.rotate(toRadians(this.data.direction));\n\t\t\t\t} else {// cone\n\t\t\t\t\tconst d = canvas.dimensions;\n\t\t\t\n\t\t\t\t\t// Extract and prepare data\n\t\t\t\t\tlet {direction, distance, angle} = this.data;\n\t\t\t\t\tdistance *= (d.size / d.distance);\n\t\t\t\t\tdirection = toRadians(direction);\n\t\t\t\t\tconst width = this.data.distance * d.size / d.distance;\n\n\t\t\t\t\tconst angles = [(angle/-2), (angle/2)];\n\t\t\t\t\tdistance = distance / Math.cos(toRadians(angle/2));\n\t\t\t\n\t\t\t\t\t// Get the cone shape as a polygon\n\t\t\t\t\tconst rays = angles.map(a => Ray.fromAngle(0, 0, direction + toRadians(a), distance+1));\n\t\t\t\t\tconst height = Math.sqrt((rays[0].B.x - rays[1].B.x) * (rays[0].B.x - rays[1].B.x)\n\t\t\t\t\t\t\t\t\t\t\t\t\t+ (rays[0].B.y - rays[1].B.y) * (rays[0].B.y - rays[1].B.y));\n\t\t\t\t\tmat.scale(width / this.texture.width, height / this.texture.height);\n\t\t\t\t\tmat.translate(0, -height/2)\n\t\t\t\t\tmat.rotate(toRadians(this.data.direction));\n\t\t\t\t}\n\t\t\t\tthis.template.beginTextureFill({\n\t\t\t\t\ttexture: this.texture,\n\t\t\t\t\tmatrix: mat,\n\t\t\t\t\talpha: 0.8\n\t\t\t\t});\n\t\t\t\t// move into draw or so\n\t\t\t\tconst source = getProperty(this.texture, \"baseTexture.resource.source\")\n\t\t\t\tif ( source && (source.tagName === \"VIDEO\") ) {\n\t\t\t\t\tsource.loop = true;\n\t\t\t\t\tsource.muted = true;\n\t\t\t\t\tgame.video.play(source);\n\t\t\t\t}\n\t\t}`);\n\n\t\tHooks.on('renderMeasuredTemplateConfig', (app, html, data) => {\n\t\t\thtml[0].querySelector('.file-picker').dataset.type = 'imagevideo'\n\t\t});\n\t}\n\t\n\tif (game.settings.get('mess', 'templateAutoTargeting')) {\n\t\tnewFun = newFun.replace(/this\\.\\_borderThickness/, \"this.texture && !this._hover ? 0 : this._borderThickness\");\n\t\tnewFun = newFun.replace(/return\\sthis\\;/, `\n\t\t\tconst grid = canvas.grid;\n\t\t\t// only show grid highlights on hover\n\t\t\tif (this.texture) {\n\t\t\t\tconst hl = grid.getHighlightLayer(\\`Template.\\$\\{this.id\\}\\`);\n\t\t\t\tif (hl)\n\t\t\t\t\thl.renderable = this._hover;\n\t\t\t}\n\t\t\treturn this;`);\n\t}\n\n\tMeasuredTemplate.prototype.refresh = Function(`\"use strict\"; return ( function ${newFun} )`)();\n\n\t\n\tif (game.settings.get('mess', 'templateAutoTargeting')) {\n\t\tMeasuredTemplate.prototype.getTargets = getTargets;\n\t\tMeasuredTemplate.prototype.isTokenInside = isTokenInside;\n\n\t\tconst oldFun = MeasuredTemplate.prototype._onDragLeftMove;\n\t\tMeasuredTemplate.prototype._onDragLeftMove = function(ev) {\n\t\t\tconst ret = oldFun.bind(this)(ev);\n\n\t\t\tfor (let c of ev.data.clones)\n\t\t\t\tthis.getTargets(c);\n\n\t\t\treturn ret;\n\t\t}\n\t}\n}\n\nexport async function dndTemplateSettings() {\n  if (game.system.id !== 'dnd5e') return;\n\n\tconst importedJS = (await import(/* webpackIgnore: true */ '/systems/dnd5e/module/pixi/ability-template.js'))\n\tconst AbilityTemplate = importedJS.default || importedJS.AbilityTemplate;\n\n\t// Auto texture creation from item\n\tif (game.settings.get('mess', 'modify-templates')) {\n\t\tHooks.on('renderItemSheet', itemHook);\n\t\t\n\t\t\n\t\tconst _originalFromItem = AbilityTemplate.fromItem;\n\t\tAbilityTemplate.fromItem = function(item) {\n\t\t\tconst template = _originalFromItem.bind(this)(item);\n\t\t\t\n\t\t\t// generate a texture based on the items dmg type, ...\n\t\t\t// Add settings to define custom templates for stuff.\n\t\t\tlet path = item.getFlag('mess', 'templateTexture');\n\t\t\tif (!path && item.hasDamage) {\n\t\t\t\tconst settings = game.settings.get('mess', 'templateTexture') || {};\n\t\t\t\tpath = settings[item.data.data.damage.parts[0][1]] || {};\n\t\t\t\tpath = path[template.data.t];\n\t\t\t}\n\t\t\tif (path)\n\t\t\t\tloadTexture(path).then(tex => {\n\t\t\t\t\ttemplate.texture = tex;\n\t\t\t\t\ttemplate.data.texture = path;\n\t\t\t\t\ttemplate.refresh();\n\t\t\t\t})\n\t\t\ttemplate.item = item;\n\t\t\treturn template;\n\t\t}\n\t}\n\n\n\tif (game.settings.get('mess', 'templateAutoTargeting')) {\n\t\t//  rather ugly, maybe find a better way at some point :shrug:\n\t\tconst origPrevListeners = AbilityTemplate.prototype.activatePreviewListeners.toString();\n\t\tconst newFun = origPrevListeners.replace(/this\\.refresh\\(\\)\\;/, \n\t\t\t\t\t// get targets\n\t\t\t\t\t\t`this.refresh();\n\t\t\t\t\t\tthis.getTargets(this);\n\t\t\t\t\t`);\n\n\t\tAbilityTemplate.prototype.getTargets = getTargets;\n\t\tAbilityTemplate.prototype.isTokenInside = isTokenInside;\n\n\t\tAbilityTemplate.prototype.activatePreviewListeners = Function(`\"use strict\"; return ( function ${newFun} )`)();\n\t}\n}\n\n\nfunction isTokenInside(token) {\n\tconst grid = canvas.scene.data.grid,\n\t\t\t\ttemplatePos = {x: this.data.x, y: this.data.y};\n\t// Check for center of  each square the token uses.\n\t// e.g. for large tokens all 4 squares\n\tconst startX = token.width >= 1 ? 0.5 : token.width / 2;\n\tconst startY = token.height >= 1 ? 0.5 : token.height / 2;\n\tfor (let x = startX; x < token.width; x++) {\n\t\tfor (let y = startY; y < token.height; y++) {\n\t\t\tconst currGrid = {\n\t\t\t\tx: token.x + x * grid - templatePos.x,\n\t\t\t\ty: token.y + y * grid - templatePos.y\n\t\t\t};\n\t\t\tconst contains = this.shape.contains(currGrid.x, currGrid.y);\n\t\t\tif (contains) return true;\n\t\t}\n\t}\n\treturn false;\n}\n\nfunction getTargets(template) {\n\tconst tokens = canvas.scene.getEmbeddedCollection('Token');\n\tlet targets = [];\n\t\n\tfor (const token of tokens)\n\t\tif (template.isTokenInside(token)) { targets.push(token._id); }\n\tgame.user.updateTokenTargets(targets);\n}\n\nasync function itemHook(app, html) {\n\tconst div = document.createElement('div');\n\tdiv.classList.add('form-group');\n\tdiv.appendChild(document.createElement('label')).innerText = game.i18n.localize('MESS.itemSheet.templateTexture');\n\tconst formField = div.appendChild(document.createElement('div'));\n\tformField.classList.add('form-fields');\n\tconst inp = formField.appendChild(document.createElement('input'));\n\tinp.dataset.dtype = 'String';\n\tinp.type = 'text';\n\tinp.name = 'flags.mess.templateTexture';\n\tinp.value = app.object.getFlag('mess', 'templateTexture') || \"\";\n\n\tformField.insertAdjacentHTML('beforeend', `\n\t\t<button type=\"button\" class=\"file-picker\" data-type=\"imagevideo\" data-target=\"flags.mess.templateTexture\" title=\"Browse Files\" tabindex=\"-1\">\n\t\t\t<i class=\"fas fa-file-import fa-fw\"></i>\n\t\t</button>\n\t`);\n\tconst button = formField.querySelector('button');\n\tbutton.style.flex = '0';\n  app._activateFilePicker(button);\n\tconst target = html[0].querySelector('[name=\"data.target.units\"]');\n  if (target)\n\t\ttarget.closest('.form-group').after(div);\n}","export default async function addPreparedSpellTracker() {\n\tHooks.on('renderActorSheet', async function (app,  html, data) {\n\t\tconst actor = await fromUuid(`Actor.${data.actor._id}`);\n\t\tif (actor.isNPC) return;\n\t\t\n\t\tconst spellDc = html[0].querySelector('.spell-dc');\n\t\tif (!spellDc) return;\n\t\tlet tracker = document.createElement('div');\n\t\ttracker.classList.add('spell-detail');\n\t\ttracker.classList.add('spell-slots');\n\t\ttracker.style.flex = '1';\n\t\ttracker.style.border = 'none';\n\t\tconst spanPrep = tracker.appendChild(document.createElement('span'));\n\t\tspanPrep.innerText = `${game.i18n.localize('MESS.actorSheet.preparedSpellTracker')}: ${data.preparedSpells}`;\n\n\t\tconst sep = tracker.appendChild(document.createElement('span'));\n\t\tsep.innerText = ' / ';\n\t\tsep.classList.add('sep');\n\n\t\tconst max = tracker.appendChild(document.createElement('input'));\n\t\tmax.type = 'text';\n\t\tmax.value = actor.getFlag('mess', 'maxPreparedSpells') || 0;\n\t\tmax.addEventListener('change', async function(ev) {\n\t\t\tev.preventDefault();\n\t\t\tev.stopPropagation();\n\t\t\tconst val = Number(ev.currentTarget.value);\n\t\t\tif (isNaN(val)) {\n\t\t\t\tev.currentTarget.value = actor.getFlag('mess', 'maxPreparedSpells') || 0;\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\tactor.setFlag('mess', 'maxPreparedSpells', val);\n\t\t\treturn false;\n\t\t});\n\t\t\n\t\tif (app.constructor.name === 'Tidy5eSheet') {\n\t\t\tconst el = html[0].querySelector('.spellcasting-ability');\n\t\t\tif (!el)\n\t\t\t\treturn;\n\t\t\tel.appendChild(tracker, el);\n\t\t} else {\n\t\t\tconst el = html[0].querySelector('.spellbook .inventory-list');\n\t\t\tif (!el)\treturn;\n\t\t\ttracker.style.flex = '0';\n\t\t\ttracker.style.alignSelf = 'flex-start';\n\t\t\ttracker.style.margin = '0 8px';\n\t\t\tel.parentNode.insertBefore(tracker, el);\n\t\t}\n\t});\n}","function getAllDmg(li) {\n\tconst results = Array.from(li[0].parentNode.querySelectorAll('.mess-dice-result:not(.mess-versatile')).map(e => Number(e.querySelector('span').innerText));\n\treturn results.reduce((a, b) => a + b, 0);\n}\n\nfunction getAllVersatile(li) {\n\tconst resultArray = Array.from(li[0].parentNode.querySelectorAll('.mess-dice-result'));\n\tif (resultArray.length > 1 && resultArray[1].classList.contains('mess-versatile'))\n\t\tresultArray.splice(0,1)\n\tconst results = resultArray.map(e => Number(e.querySelector('span').innerText));\n\treturn results.reduce((a, b) => a + b, 0);\n}\n\nexport default function modifyApplyDmg() {\n\tconst canApply = (li) => true || canvas.tokens.controlled.length;\n\tconst canApplyNonVersatile = (li) => canApply(li) && li[0].parentNode.querySelector('.mess-dice-result:not(.mess-versatile)');\n\tconst canApplyVersatile = (li) => canApply(li) && li[0].parentNode.querySelector('.mess-versatile');\n\tconst hasTarget = (li) => !!li[0].closest('.mess-attack-card').dataset.targetId;\n\tconst hasNoTarget = (li) => !hasTarget(li);\n\tconst contextOptionsDmg = [\n\t\t{\n\t\t\tname: game.i18n.localize(\"MESS.attackCard.contextMenu.applyTarget\"),\n\t\t\tcondition: hasTarget\n\t\t},\n\t\t{\n\t\t\tname: game.i18n.localize(\"MESS.attackCard.contextMenu.applySelected\"),\n\t\t\tcondition: hasNoTarget\n\t\t},\n\t\t{\n\t\t\tname: game.i18n.localize(\"MESS.attackCard.contextMenu.dmg\"),\n\t\t\tcondition: canApplyNonVersatile,\n\t\t\ticon: '<i class=\"fas fa-user-injured\"></i>'\n\t\t},\n\t\t{\n\t\t\tname: 'full',\n\t\t\ticon: '',\n\t\t\tcondition: canApplyNonVersatile,\n\t\t\tcallback: (target, li) => applyDamage(li, 1),\n\t\t\tcontent: (li) => `<span>${getAllDmg(li)}</span><label>${game.i18n.localize(\"MESS.attackCard.contextMenu.full\")}</label>`\n\t\t},\n\t\t{\n\t\t\tname: 'half',\n\t\t\ticon: '',\n\t\t\tcondition: canApplyNonVersatile,\n\t\t\tcallback: (target, li) => applyDamage(li, 1),\n\t\t\tcontent: (li) => `<span>${Math.max(Math.floor(getAllDmg(li) * 0.5), 1)}</span><label>${game.i18n.localize(\"MESS.attackCard.contextMenu.half\")}</label>`\n\t\t},\n\t\t{\n\t\t\tname: 'double',\n\t\t\ticon: '',\n\t\t\tcondition: canApplyNonVersatile,\n\t\t\tcallback: (target, li) => applyDamage(li, 1),\n\t\t\tcontent: (li) => `<span>${Math.floor(getAllDmg(li) * 2)}</span><label>${game.i18n.localize(\"MESS.attackCard.contextMenu.double\")}</label>`\n\t\t},\n\t\t{\n\t\t\tname: game.i18n.localize(\"MESS.attackCard.contextMenu.healing\"),\n\t\t\tcondition: canApplyNonVersatile,\n\t\t\ticon: '<i class=\"fas fa-prescription-bottle-alt\"></i>'\n\t\t},\n\t\t{\n\t\t\tname: 'full',\n\t\t\ticon: '',\n\t\t\tcondition: canApplyNonVersatile,\n\t\t\tcallback: (target, li) => applyDamage(li, -1),\n\t\t\tcontent: (li) => `<span>${getAllDmg(li)}</span><label>${game.i18n.localize(\"MESS.attackCard.contextMenu.full\")}</label>`\n\t\t},\n\t\t{\n\t\t\tname: [game.i18n.localize('DND5E.Versatile'), ' - ', game.i18n.localize(\"MESS.attackCard.contextMenu.dmg\")],\n\t\t\tcondition: canApplyVersatile,\n\t\t\ticon: '<i class=\"fas fa-user-injured\"></i>'\n\t\t},\n\t\t{\n\t\t\tname: 'full',\n\t\t\ticon: '',\n\t\t\tcondition: canApplyVersatile,\n\t\t\tcallback: (target, li) => applyDamage(li, 1),\n\t\t\tcontent: (li) => `<span>${getAllVersatile(li)}</span><label>${game.i18n.localize(\"MESS.attackCard.contextMenu.full\")}</label>`\n\t\t},\n\t\t{\n\t\t\tname: 'half',\n\t\t\ticon: '',\n\t\t\tcondition: canApplyVersatile,\n\t\t\tcallback: (target, li) => applyDamage(li, 1),\n\t\t\tcontent: (li) => `<span>${Math.max(Math.floor(getAllVersatile(li) * 0.5), 1)}</span><label>${game.i18n.localize(\"MESS.attackCard.contextMenu.half\")}</label>`\n\t\t},\n\t\t{\n\t\t\tname: 'double',\n\t\t\ticon: '',\n\t\t\tcondition: canApplyVersatile,\n\t\t\tcallback: (target, li) => applyDamage(li, 1),\n\t\t\tcontent: (li) => `<span>${Math.floor(getAllVersatile(li) * 2)}</span><label>${game.i18n.localize(\"MESS.attackCard.contextMenu.double\")}</label>`\n\t\t},\n\t\t{\n\t\t\tname: [game.i18n.localize('DND5E.Versatile'), ' - ', game.i18n.localize(\"MESS.attackCard.contextMenu.healing\")],\n\t\t\tcondition: canApplyVersatile,\n\t\t\ticon: '<i class=\"fas fa-prescription-bottle-alt\"></i>'\n\t\t},\n\t\t{\n\t\t\tname: 'full',\n\t\t\ticon: '',\n\t\t\tcondition: canApplyVersatile,\n\t\t\tcallback: (target, li) => applyDamage(li, -1),\n\t\t\tcontent: (li) => `<span>${getAllVersatile(li)}</span><label>${game.i18n.localize(\"MESS.attackCard.contextMenu.full\")}</label>`\n\t\t}\n\t]\n\n\n\tconst contextOptionsRoll = [\n\t\t{\n\t\t\tname: game.i18n.localize(\"MESS.attackCard.contextMenu.applyTarget\"),\n\t\t\tcondition: hasTarget\n\t\t},\n\t\t{\n\t\t\tname: game.i18n.localize(\"MESS.attackCard.contextMenu.applySelected\"),\n\t\t\tcondition: hasNoTarget\n\t\t},\n\t\t{\n\t\t\tname: game.i18n.localize(\"MESS.attackCard.contextMenu.dmg\"),\n\t\t\tcondition: canApply,\n\t\t\ticon: '<i class=\"fas fa-user-injured\"></i>'\n\t\t},\n\t\t{\n\t\t\tname: 'full',\n\t\t\ticon: '',\n\t\t\tcondition: canApply,\n\t\t\tcallback: (target, li) => applyDamage(li, 1),\n\t\t\tcontent: (li) => `<span>${li[0].querySelector('span').innerText}</span><label>${game.i18n.localize(\"MESS.attackCard.contextMenu.full\")}</label>`\n\t\t},\n\t\t{\n\t\t\tname: 'half',\n\t\t\ticon: '',\n\t\t\tcondition: canApply,\n\t\t\tcallback: (target, li) => applyDamage(li, 1),\n\t\t\tcontent: (li) => `<span>${Math.max(Math.floor(Number(li[0].querySelector('span').innerText) * 0.5), 1)}</span><label>${game.i18n.localize(\"MESS.attackCard.contextMenu.half\")}</label>`\n\t\t},\n\t\t{\n\t\t\tname: 'double',\n\t\t\ticon: '',\n\t\t\tcondition: canApply,\n\t\t\tcallback: (target, li) => applyDamage(li, 1),\n\t\t\tcontent: (li) => `<span>${Math.floor(Number(li[0].querySelector('span').innerText) * 2)}</span><label>${game.i18n.localize(\"MESS.attackCard.contextMenu.double\")}</label>`\n\t\t},\n\t\t{\n\t\t\tname: game.i18n.localize(\"MESS.attackCard.contextMenu.healing\"),\n\t\t\tcondition: canApply,\n\t\t\ticon: '<i class=\"fas fa-prescription-bottle-alt\"></i>'\n\t\t},\n\t\t{\n\t\t\tname: 'full',\n\t\t\ticon: '',\n\t\t\tcondition: canApply,\n\t\t\tcallback: (target, li) => applyDamage(li, -1),\n\t\t\tcontent: (li) => `<span>${li[0].querySelector('span').innerText}</span>`\n\t\t}\n\t]\n\n\n\tContextMenu.prototype.bind = Function('\"use strict\"; return  ( function ' + ContextMenu.prototype.bind.toString().replace(/this\\.render\\(parent\\)/,`this.render(parent, event)`) + ')')();\n\n\tHooks.on('renderChatLog', (app, html, options) => {\n\t\tnew MessContextMenu(html.find('#chat-log'), \".mess-chat-dmg .mess-dice-result\", contextOptionsRoll);\n\t\tnew MessContextMenu(html.find('#chat-log'), \".mess-chat-dmg .mess-chat-roll-type\", contextOptionsDmg);\n\t})\n\n\tHooks.on('getChatLogEntryContext', function (html, options) {\n\t\tsetProperty(game, 'mess.chatLogEntryContextOptions', options);\n\t\t\n\t\t// Modify existing applies to only work on default rolls and not mess-rolls\n\t\tconst canApply = li => canvas.tokens.controlled.length \n\t\t\t\t\t\t\t\t\t\t\t\t&& li.find(\".dice-roll .dice-result\").length;\n\t\tfor (let i = 1; i < options.length; i++) \n\t\t\toptions[i].condition = canApply;\n\t});\n}\n\nclass MessContextMenu extends ContextMenu {\n\tconstructor(...args) {\n\t\tsuper(...args);\n\n\t\tthis._menuItems = this.menuItems;\n\t}\n\n\trender(target, event) {\n\t\tconst filteredItems = this._menuItems.filter(item => {\n\t\t\tif (!item.condition) return true;\n\t\t\tif (!(item.condition instanceof Function)) return item.condition;\n\t\t\treturn item.condition(target);\n\t\t})\n\n\t\tif (filteredItems.length) event.stopPropagation();\n\t\telse return;\n\t\tthis.menuItems = filteredItems.map(e => {\n\t\t\tif (e.content)\n\t\t\t\te.name = e.content(target);\n\t\t\treturn e;\n\t\t});\n\n    let html = $(\"#context-menu\").length ? $(\"#context-menu\") : $('<nav id=\"context-menu\"></nav>');\n    let ol = $('<ol class=\"context-items\"></ol>');\n    html.html(ol);\n\n\t\tconst frag = document.createDocumentFragment();\n\t\tfor (let item of this.menuItems) {\n\t\t\tconst li = document.createElement('li')\n\t\t\t\n\t\t\tif (item.name instanceof Array)\n\t\t\t\titem.name = item.name.map(e => game.i18n.localize(e)).join(\"\");\n\n\t\t\tif (item.icon)\n\t\t\t\tli.innerHTML = `${item.icon}${game.i18n.localize(item.name)}`;\n\t\t\telse\n\t\t\t\tli.innerHTML = game.i18n.localize(item.name);\n\n\t\t\tif (item.callback) {\n\t\t\t\tli.addEventListener('click',  ev => {\n\t\t\t\t\tev.preventDefault();\n\t\t\t\t\tev.stopPropagation();\n\t\t\t\t\titem.callback(target, li);\n\t\t\t\t\tthis.close();\n\t\t\t\t});\n\t\t\t\tli.classList.add('context-item');\n\t\t\t} else\n\t\t\t\tli.classList.add('mess-context-menu-header');\n\n\t\t\tfrag.appendChild(li);\n\t\t}\n\n\t\tol[0].appendChild(frag);\n\n    // Append to target\n    this._setPosition(html, target);\n\n    // Animate open the menu\n    return this._animateOpen(html);\n\t}\n\n\t_setPosition(html, target) {\n\t\thtml.removeClass(\"expand-up expand-down\");\n\t\tsuper._setPosition(html, target);\n\t}\n}\n\nasync function applyDamage(target, sign) {\n\tconst amount = Number(target.querySelector('span').innerText);\n\tconst card = target.closest('.mess-attack-card')\n\tconst targetId = card.dataset.targetId\n\tif (targetId) {\n\t\tconst sceneId = card.dataset.sceneId;\n\t\tconst scene = game.scenes.get(sceneId);\n\t\tif (!scene) {\n\t\t\tui.notifications.error(game.i18n.localize(\"MESS.attackCard.applyDamage.sceneNotFound\"));\n\t\t\treturn;\n\t\t}\n\t\tconst token = new Token(scene.getEmbeddedEntity(\"Token\", targetId));\n\t\tif (!token) {\n\t\t\tui.notifications.error(game.i18n.localize(\"MESS.attackCard.applyDamage.targetNotFound\"));\n\t\t\treturn;\n\t\t}\n\t\tif (!token.owner) {\n\t\t\tui.notifications.error(game.i18n.localize(\"MESS.attackCard.applyDamage.targetNotOwner\"));\n\t\t\treturn;\n\t\t}\n\t\tconst actor = token.actor;\n\t\tactor.applyDamage(amount, sign);\n\t} else {\n\t\tconst tokens = canvas.tokens.controlled;\n\t\tif (!tokens.length) {\n\t\t\tui.notifications.error(game.i18n.localize('MESS.attackCard.contextMenu.error'));\n\t\t\treturn;\n\t\t}\n\t\t\n\t\tfor (const token of tokens) {\n\t\t\tconst a = token.actor;\n\t\t\ta.applyDamage(amount, sign);\n\t\t}\n\t}\n}","export default function() {\n\n\tHooks.on('renderChatLog', chatLogHook);\n\n\tregisterSettings();\n};\n\nfunction registerSettings() {\n\tgame.settings.register('mess', `${game.userId}.adv-selector`, {\n\t\tname: 'Mess - Advantage Selector',\n\t\tdefault: 'normal',\n\t\ttype: String,\n\t\tscope: 'user'\n\t});\n\tgame.settings.register('mess', `${game.userId}.autoroll-selector`, {\n\t\tname: 'Mess - Autoroll Selector',\n\t\tdefault: {hit: false, dmg: false},\n\t\ttype: Object,\n\t\tscope: 'user'\n\t});\n}\n\nasync function chatLogHook(app, html, data) {\n\thtml[0].classList.add('mess');\n\tconsole.log(\"qwe\", game.user, game.user.isGM)\n\tif (game.user.isGM)\n\t\thtml[0].classList.add('mess-is-gm');\n\tconst div = document.createElement('div');\n\tdiv.classList.add('mess-roll-control');\n\n\tconst advSelector = game.settings.get('mess', `${game.userId}.adv-selector`);\n\tconst autoRollSelector = game.settings.get('mess', `${game.userId}.autoroll-selector`);\n\tconst templateData = {\n\t\tadvantage: advSelector === 'advantage',\n\t\tnormal: advSelector ===  'normal',\n\t\tdisadvantage: advSelector ===  'disadvantage',\n\t\t...autoRollSelector\n\t}\n\n\tdiv.insertAdjacentHTML('afterbegin', await renderTemplate('modules/mess/templates/roll-control.html', templateData));\n\n\tdiv.querySelectorAll('.mess-adv-selector a').forEach(e => {\n\t\te.addEventListener('click', async function(ev) {\n\t\t\tev.preventDefault();\n\t\t\tev.stopPropagation();\n\t\t\tconst arr = Array.from(ev.currentTarget.parentNode.querySelectorAll('a'));\n\t\t\tconst currIdx = arr.findIndex(e => e.classList.contains('mess-selected'));\n\t\t\tarr[currIdx].classList.remove('mess-selected');\n\t\t\tconst newSelected = arr[(currIdx + 1) % arr.length];\n\t\t\tnewSelected.classList.add('mess-selected');\n\t\t\tgame.settings.set('mess', `${game.userId}.adv-selector`, newSelected.name);\n\t\t});\n\t\t// Toggle in the opposite direction with right click\n\t\te.addEventListener('contextmenu', async function(ev) {\n\t\t\tev.preventDefault();\n\t\t\tev.stopPropagation();\n\t\t\tconst arr = Array.from(ev.currentTarget.parentNode.querySelectorAll('a'));\n\t\t\tconst currIdx = arr.findIndex(e => e.classList.contains('mess-selected'));\n\t\t\tarr[currIdx].classList.remove('mess-selected');\n\t\t\tconst newSelected = arr[(currIdx + arr.length - 1) % arr.length]; // add length cause javascripts modulo is strange\n\t\t\tnewSelected.classList.add('mess-selected');\n\t\t\tgame.settings.set('mess', `${game.userId}.adv-selector`, newSelected.name);\n\t\t})\n\t});\n\tdiv.querySelectorAll('.mess-autoroll-selector a') .forEach(e => {\n\t\te.addEventListener('click', async function(ev) {\n\t\t\tev.preventDefault();\n\t\t\tev.stopPropagation();\n\n\t\t\t\n\t\t\tev.currentTarget.classList.toggle('mess-selected');\n\t\t\tlet data = game.settings.get('mess', `${game.userId}.autoroll-selector`);\n\t\t\tdata[ev.currentTarget.name] = ev.currentTarget.classList.contains('mess-selected');\n\t\t\tgame.settings.set('mess', `${game.userId}.autoroll-selector`, data);\n\t\t})\n\t});\n\n\tconst controls = document.getElementById('chat-controls');\n\tcontrols.insertBefore(div, controls.childNodes[0]);\n}","import {getTargetToken, hasTarget} from './util.js';\n\n/**\n * All the functions provided here are heavily based on Foundrys DnD5e system, authored by Atropos.\n * Original repository: https://gitlab.com/foundrynet/dnd5e\n * Original Author: Atropos\n * License: GNU GPLv3\n */\n\nfunction getD20Modifier() {\n\treturn document.getElementById('mess-roll-mod').value;\n}\n\nfunction getAdvantageSettings() {\n\treturn game.settings.get('mess', `${game.userId}.adv-selector`);\n}\n\nexport async function rollD20(data) {\n\tlet adv = getAdvantageSettings();\n\t// Determine the d20 roll and modifiers\n\tlet nd = 1;\n\tlet mods = data.halflingLucky ? \"r=1\" : \"\";\n\n\t// Handle advantage\n\tif ( adv === \"advantage\" ) {\n\t\tnd = data.elvenAccuracy ? 3 : 2;\n\t\tmods += \"kh\";\n\t\tdata.title += ` (${game.i18n.localize(\"DND5E.Advantage\")})`;\n\t}\n\n\t// Handle disadvantage\n\telse if ( adv === \"disadvantage\" ) {\n\t\tnd = 2;\n\t\tmods += \"kl\";\n\t\tdata.title += ` (${game.i18n.localize(\"DND5E.Disadvantage\")})`;\n\t}\n\n\t// Include the d20 roll\n\tlet diceFormula = `${nd}d20${mods}`;\n\tif (data.reliableTalent) diceFormula = `{${nd}d20${mods},10}kh`;\n\tdata.parts.unshift(diceFormula);\n\n\tconst d20Mod = getD20Modifier();\n\tif (d20Mod)\n\t\tdata.parts.push(d20Mod);\n\t\n\tlet r = new Roll(data.parts.join('+'), data);\n\tr.roll();\n\tconst d20 = r.parts[0].total;\n\tlet templateData = {...data, \n\t\ttooltip: await r.getTooltip(),\n\t\troll: r,\n\t\tcrit:  d20 >= 20,\n\t\tfumble: d20 <= 1\n\t}\n\n\tconst template = await renderTemplate('modules/mess/templates/roll-card.html', templateData);\n\n\tlet chatData = {\n\t\tuser: game.user._id,\n\t\ttype: CONST.CHAT_MESSAGE_TYPES.OTHER,\n\t\tcontent: template,\n\t\tspeaker: {\n\t\t\tactor: this,\n\t\t\talias: this.name\n\t\t}\n\t};\n\tlet rollMode = game.settings.get(\"core\", \"rollMode\");\n\tif ( [\"gmroll\", \"blindroll\"].includes(rollMode) ) chatData[\"whisper\"] = ChatMessage.getWhisperIDs(\"GM\");\n\tif ( rollMode === \"blindroll\" ) chatData[\"blind\"] = true;\n\tconst dsn = game.mess.diceSoNice; \n\tif (dsn) {\n\t\tlet whispers = null;\n\t\tlet blind = false;\n\t\tif ( [\"gmroll\", \"blindroll\"].includes(rollMode) ) whispers = ChatMessage.getWhisperIDs(\"GM\");\n\t\tif ( rollMode === \"blindroll\" ) blind = true;\n\t\t\n\t\tawait game.dice3d.showForRoll(r, game.user, true, whispers, blind);\n\t}\n\tChatMessage.create(chatData);\n}\n\n/**\n * Extracts the data needed for an attack roll.\n * @param {ActorEntity} actor\n * @param {ItemEntity} item \n */\nexport async function getToHitData({actor, item}) {\n\tif (!item.hasAttack) return null;\n\tconst actorData = actor.data.data;\n\tconst itemData = item.data.data;\n\tconst flags = actor.data.flags.dnd5e || {};\n\t\n\tlet rollData = item.getRollData();\n\n\t// Define Roll bonuses\n\tconst parts = [`@mod`];\n\tif ( (item.data.type !== \"weapon\") || itemData.proficient ) {\n\t\tparts.push(\"@prof\");\n\t}\n\trollData.parts = parts;\n\n\t// Expanded weapon critical threshold\n\tif (( item.data.type === \"weapon\" ) && flags.weaponCriticalThreshold) {\n\t\trollData.critical = parseInt(flags.weaponCriticalThreshold);\n\t}\n\n\t// Elven Accuracy\n\tif ( [\"weapon\", \"spell\"].includes(item.data.type) ) {\n\t\tif (flags.elvenAccuracy && [\"dex\", \"int\", \"wis\", \"cha\"].includes(item.abilityMod)) {\n\t\t\trollData.elvenAccuracy = true;\n\t\t}\n\t}\n\n\t// Apply Halfling Lucky\n\tif ( flags.halflingLucky ) rollData.halflingLucky = true;\n\n\t// Attack Bonus\n\tconst actorBonus = actorData.bonuses[itemData.actionType] || {};\n\tif ( itemData.attackBonus || actorBonus.attack ) {\n\t\t// parts.push(\"@atk\");\n\t\trollData[\"atk\"] = [itemData.attackBonus, actorBonus.attack].filterJoin(\" + \");\n\t\tif (!isNaN(Number(rollData[\"atk\"]))) {\n\t\t\tparts.push(\"@atk\");\n\t\t}\n\t}\n\n\tlet roll = new Roll(rollData.parts.join('+'), rollData);\n\trollData.totalModifier = roll._safeEval(roll.formula);\n\trollData.totalModifier = rollData.totalModifier >= 0 ? '+' + rollData.totalModifier : rollData.totalModifier;\n\tif (rollData[\"atk\"] && !roll._formula.includes('@atk')) {\n\t\trollData.parts.push(\"@atk\");\n\t\troll = new Roll(rollData.parts.join('+'), rollData);\n\t\trollData.totalModifier += `+${rollData[\"atk\"]}`;\n\t}\n\n\tconst situationalModifier = getD20Modifier();\n\tif (situationalModifier) {\n\t\trollData.parts.push(situationalModifier);\n\t\troll = new Roll(rollData.parts.join('+'), rollData);\n\t\trollData.totalModifier += `+${situationalModifier}`;\n\t}\n\trollData.formula = roll.formula;\n\trollData.terms = roll._formula;\n\treturn rollData;\n}\n\n/**\n * Rolls the to hit roll and updates the html target. Also updates the message if found.\n * @param {Click Event} ev event targetting the button which initiated a real or virtual click event\n */\nexport async function rollToHit(ev) {\n\t// Extract card data\n\tconst button = ev.currentTarget;\n\tbutton.disabled = true;\n\tconst card = button.closest(\".chat-card\");\n\tconst messageId = card.closest(\".message\").dataset.messageId;\n\t// Check if user owns chat message, else return\n\tif (messageId) {\n\t\tev.stopPropagation(); ev.preventDefault();\n\t\tconst message = game.messages.get(messageId);\n\t\tif (!(message.owner || message.isAuthor)) {\n\t\t\tui.notifications.error('You do not own the permissions to make that roll!');\n\t\t\treturn false;\n\t\t}\n\t}\n\t// Get the Actor from a synthetic Token\n\tconst actor = CONFIG.Item.entityClass._getChatCardActor(card);\n\tif (!actor.owner) return false;\n\n\t// Get the Item\n\tconst item = actor.getOwnedItem(card.dataset.itemId);\n\tif ( !item ) {\n\t\treturn ui.notifications.error(`The requested item ${card.dataset.itemId} no longer exists on Actor ${actor.name}`)\n\t}\n\n\tlet rollData = await getToHitData({actor, item});\n\tlet adv = getAdvantageSettings();\n\t// Determine the d20 roll and modifiers\n\tlet nd = 1;\n\tlet mods = rollData.halflingLucky ? \"r=1\" : \"\";\n\n\t// Handle advantage\n\tif ( adv === \"advantage\" ) {\n\t\tnd = rollData.elvenAccuracy ? 3 : 2;\n\t\tmods += \"kh\";\n\t}\n\n\t// Handle disadvantage\n\telse if ( adv === \"disadvantage\" ) {\n\t\tnd = 2;\n\t\tmods += \"kl\";\n\t}\n\n\t// Include the d20 roll\n\trollData.parts.unshift(`${nd}d20${mods}`);\n\t\n\tlet r = new Roll(rollData.parts.join('+'), rollData);\n\tr.roll();\n\tlet div = document.createElement('div');\n\t// div.title = `${rollData.parts[0]}+${rollData.terms} = ${r.formula} = ${r.total}. Click to see rolls.`;\n\tdiv.classList.add('dice-roll');\n\tdiv.classList.add('mess-dice-result');\n\tif (game.user.isGM)\n\t\tdiv.classList.add('mess-gm-dice');\n\tconst span = div.appendChild(document.createElement('span'));\n\tspan.classList.add('mess-roll-container');\n\tspan.innerHTML = `<span class='mess-roll-total'>${r.total}</span>`;\n\n\tdiv.insertAdjacentHTML('beforeend', await r.getTooltip());\n\tlet customTooltip = '';\n\tconst terms = rollData.terms.split('+'); // only adding + terms here anyway\n\tconst dataTerms = rollData.formula.split(/(?=[+-])/);\n\tfor (let i = 0; i < terms.length; i++) {\n\t\tconst term = terms[i];\n\t\tconst num = Number(dataTerms[i]);\n\t\tif (isNaN(num)) continue;\n\t\tcustomTooltip += `<section class=\"tooltip-part\">\n\t\t\t<div class=\"dice\">\n\t\t\t\t<p class=\"part-formula\">\n\t\t\t\t\t${term}\n\t\t\t\t\t<span class=\"part-total\">${num >= 0 ? '+'+num : num}</span>\n\t\t\t\t</p>\n\t\t\t</div>\n\t\t</section>`\n\t}\n\tdiv.querySelector('.dice-tooltip').insertAdjacentHTML('beforeend', customTooltip);\n\n\tconst tooltip = div.childNodes[1];\n\ttooltip.classList.add('hidden');\n\tconst crit = rollData.critical || 20;\n\tconst fumble = rollData.fumble || 1;\n\n\tconst d20 = r.parts[0].total;\n\n\t// if (hasTarget(button)) {\n\t// \t// Check if hit\n\t// \tconst target = getTargetToken(button);\n\t// \tconst ac = target.actor.data.data.attributes.ac.value;\n\t// \tif (ac) {\n\t// \t\tif ((r.total >= ac && d20 > fumble) || d20 >= crit) {\n\t// \t\t\tspan.classList.add('mess-hit');\n\t// \t\t} else {\n\t// \t\t\tspan.classList.add('mess-miss');\n\t// \t\t}\n\t// \t}\n\t// }\n\n\tif (d20 >= crit) {\n\t\tspan.classList.add('crit');\n\t\tcard.querySelector('.mess-chat-dmg .mess-chat-roll-type').innerHTML += ' - Crit!'\n\t\tcard.querySelectorAll('.mess-button-dmg').forEach((e, idx) => {\n\t\t\tconst rgx = new RegExp(Die.rgx.die, \"g\");\n\t\t\tconst formula = e.dataset.formula.replace(rgx, (match, nd, d, mods) => {\n\t\t\t\tif (game.settings.get('mess', 'max-critical'))\n\t\t\t\t\t\tmods = \" + \" + nd * d + (mods || \"\");\n\t\t\t\telse {\n\t\t\t\t\t\tnd = nd * 2;\n\t\t\t\t\t\tmods = mods || \"\";\n\t\t\t\t}\n\t\t\t\treturn nd + \"d\" + d + mods;\n\t\t\t});\n\t\t\te.innerHTML = `<i class=\"fas fa-dice-d20\"></i> ${formula}`;\n\t\t\te.dataset.formula = formula;\n\t\t});\n\t}\n\tif (d20 <= fumble)\n\t\tspan.classList.add('fumble');\n\n\tif (messageId) {\n\t\tupdateMessage(messageId, r, card, ev.currentTarget, div);\n\t} else {\n\t\tev.currentTarget.parentNode.replaceChild(div, ev.currentTarget);\n\t}\n\n\treturn r;\n}\n\nexport async function getDmgData({actor, item, spellLevel = null}) {\n\tif (!item.hasDamage) return null;\n\tconst actorData = actor.data.data;\n\tconst itemData = item.data.data;\n\tlet rollData = item.getRollData();\n\t\n\tif ( spellLevel ) rollData.item.level = spellLevel;\n\n\trollData.parts = duplicate(itemData.damage.parts);\n\tif (itemData.damage.versatile) \n\t\trollData.parts.splice(1, 0, [itemData.damage.versatile, \"versatile\"]);\n\n\t// Only apply for items that are not bonus dmg themself\n\tif (!item.getFlag('mess', 'isBonusDamage'))\n\t\tfor (let itm of actor.items){\n\t\t\t// skip self\n\t\t\tif (itm.id === item.id) continue;\n\n\t\t\tlet bnsDmgParts = [];\n\t\t\tif (itm.getFlag('mess', 'isBonusDamage')){\n\t\t\t\tif (itm.hasDamage){\n\t\t\t\t\tconst itmData = itm.data.data;\n\t\t\t\t\tbnsDmgParts.push(itmData.damage.parts[0][0]);\n\t\t\t\t\tvar lbl = itm.name;\n\t\t\t\t\tif (itmData.damage.parts[0][1].length > 0) lbl += ` - ${game.i18n.localize('DND5E.Damage' + CONFIG.DND5E.damageTypes[itmData.damage.parts[0][1]])}`;\n\t\t\t\t\tbnsDmgParts.push(lbl);\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (bnsDmgParts.length > 0) rollData.parts.push(bnsDmgParts);\n\t\t}\n\t\n\tif (item.data.type === 'spell') {\n\t\tif (itemData.scaling.mode === 'cantrip') {\n\t\t\tlet newDmgPart = [rollData.parts[0][0]];\n\t\t\tconst lvl = actor.data.type === 'character' ? actorData.details.level : actorData.details.spellLevel;\n\t\t\titem._scaleCantripDamage(newDmgPart, lvl, itemData.scaling.formula);\n\t\t\trollData.parts[0][0] = newDmgPart[0];\n\t\t} else if (spellLevel && (itemData.scaling.mode === 'level') && itemData.scaling.formula ) {\n\t\t\tlet newDmgPart = [];\n\t\t\titem._scaleSpellDamage(newDmgPart, itemData.level, spellLevel, itemData.scaling.formula)\n\t\t\tif (newDmgPart.length > 0) {\n\t\t\t\tnewDmgPart.push('upcast dice');\n\t\t\t\trollData.parts.push(newDmgPart);\n\t\t\t}\n\t\t}\n\t}\n\t\n\tconst actorBonus = actorData.bonuses[itemData.actionType] || {};\n\tif (actorBonus.damage && parseInt(actorBonus.damage ) !== 0) {\n\t\trollData.parts[0][0] += \"+@dmg\";\n\t\trollData[\"dmg\"] = actorBonus.damage;\n\t}\n\n\tfor (let part of rollData.parts) {\n\t\tlet roll = new Roll(part[0], rollData);\n\t\tconst dmgType = CONFIG.DND5E.damageTypes[part[1]];\n\t\tif (dmgType)\n\t\t\tpart[1] = game.i18n.localize('DND5E.Damage' + CONFIG.DND5E.damageTypes[part[1]]);\n\t\telse if (part[1] === 'versatile') \n\t\t\tpart[1] = game.i18n.localize('DND5E.Versatile');\n\n\t\t//evalute damage formula's for example \"ceil(@classes.rogue.levels/2))d6\" -> \"4d6\"\n\t\tlet terms = roll._evalParentheticalTerms(roll.formula).map(t => {\n\t\t\tif ( t instanceof Roll ) {\n\t\t\t\tt.roll();\n\t\t\t\treturn t.total;\n\t\t\t}\n\t\t\treturn t;\n\t\t});\n\t\tpart.push(terms.join(''));\n\t}\n\n\treturn rollData;\n}\n\n/**\n * Rolls the dmg dice listed. If the event points towards an existing message the message will get updated\n * @param {Event} ev \n */\nexport async function rollDmg(ev) {\n\tconst contextMenu = ev.currentTarget.parentNode.querySelector('#context-menu');\n\tif (contextMenu)\n\t\tcontextMenu.remove();\n\t// Extract card data\n\tconst button = ev.currentTarget;\n\tbutton.disabled = true;\n\tconst card = button.closest(\".chat-card\");\n\tconst messageId = card.closest(\".message\").dataset.messageId;\n\n\t// Check if user owns chat message, else return\n\tif (messageId) {\n\t\tev.stopPropagation(); ev.preventDefault();\n\t\tconst message = game.messages.get(messageId);\n\t\tif (!(message.owner || message.isAuthor)) {\n\t\t\tui.notifications.error('You do not own the permissions to make that roll!');\n\t\t\treturn false;\n\t\t}\n\t}\n\tconst formula = button.dataset.formula;\n\n\tlet r = new Roll(formula);\n\tr.roll();\n\tlet div = document.createElement('div');\n\t// div.title = `${button.dataset.terms} = ${r.formula} = ${r.total}. Click to see rolls.`;\n\tdiv.classList.add('dice-roll');\n\tdiv.classList.add('mess-dice-result');\t\n\tif (game.user.isGM)\n\t\tdiv.classList.add('mess-gm-dice');\n\n\t// small helper to detect if versatile dmg was rolled\n\tconst dmgType = button.nextElementSibling.innerText;\n\tif (dmgType === game.i18n.localize('DND5E.Versatile'))\n\t\tdiv.classList.add('mess-versatile');\n\n\tconst span = div.appendChild(document.createElement('span'));\n\tspan.classList.add('mess-roll-container');\n\tspan.innerHTML = `<span class='mess-roll-total'>${r.total}</span>`;\n\tdiv.insertAdjacentHTML('beforeend', await r.getTooltip());\n\tlet customTooltip = '';\n\tconst terms = button.dataset.terms.split(/(?=[+-])/);\n\tconst dataTerms = formula.split(/(?=[+-])/).filter(e => e !== '+' && e !== '-'); // filter single + and -\n\t// i really sh ould put this into a function............\n\tfor (let i = 0; i < terms.length; i++) {\n\t\tconst term = terms[i];\n\t\tconst num = Number(dataTerms[i].replace(/\\s/g, ''));\n\n\t\tif (isNaN(num)) continue;\n\t\tcustomTooltip += `<section class=\"tooltip-part\">\n\t\t\t<div class=\"dice\">\n\t\t\t\t<p class=\"part-formula\">\n\t\t\t\t\t${term}\n\t\t\t\t\t<span class=\"part-total\">${num >= 0 ? '+'+num : num}</span>\n\t\t\t\t</p>\n\t\t\t</div>\n\t\t</section>`\n\t}\n\tdiv.querySelector('.dice-tooltip').insertAdjacentHTML('beforeend', customTooltip);\n\tconst tooltip = div.childNodes[1];\n\ttooltip.classList.add('hidden');\n\n\n\tif (messageId) {\n\t\tupdateMessage(messageId, r, card, ev.currentTarget, div);\n\t} else {\n\t\tev.currentTarget.parentNode.replaceChild(div, ev.currentTarget);\n\t}\n\treturn r;\n}\n\nasync function updateMessage(messageId, roll, card, target, div) {\n\tconst message = game.messages.get(messageId);\n\tconst dsn = game.mess.diceSoNice; \n\tif (dsn) {\n\t\tlet rollMode = game.settings.get(\"core\", \"rollMode\");\n\t\tlet whispers = null;\n\t\tlet blind = false;\n\t\tif ( [\"gmroll\", \"blindroll\"].includes(rollMode) ) whispers = ChatMessage.getWhisperIDs(\"GM\");\n\t\tif ( rollMode === \"blindroll\" ) blind = true;\n\t\t\n\t\tcard.querySelectorAll('button').forEach(e => e.disabled = true);\n\t\tawait game.dice3d.showForRoll(roll, game.user, true, whispers, blind);\n\t} else {\n\t\tAudioHelper.play({src: CONFIG.sounds.dice}, true);\n\t}\n\ttarget.parentNode.replaceChild(div, target);\n\tmessage.update({content: card.parentNode.innerHTML});\n}","import rollConrolls from './controls.js';\nimport applyDmg from './apply-dmg.js';\nimport modifyRolling from './modify-rolling.js';\n\nexport function rolling() {\n\t// Don't do this stuff if the settings are disabled.\n\tif (!game.settings.get('mess', 'modify-rolling'))\n\t\treturn;\n\trollConrolls();\n\tapplyDmg();\n\tmodifyRolling();\n}","import {rollD20, getToHitData, rollToHit, getDmgData, rollDmg} from './dice.js';\n\n\nexport default function() {\n\tsetupHooks();\n\tgame.mess.toggleItemBonusDamage = toggleItemBonusDamage;\n\n\tconst oldGetTooltip = Roll.prototype.getTooltip;\n\tRoll.prototype.getTooltip = function() {\n\t\tfor (let i = 0; i < this.parts.length; )\n\t\treturn oldGetTooltip.call(this);\n\t}\n\n\tHooks.once('diceSoNiceReady', (dice3d) => {\n    game.mess.diceSoNice = true;\n\t});\n}\n\n/**\n * Heavily based on: https://gitlab.com/foundrynet/dnd5e/-/blob/master/module/macros.js#L42\n * original author: Atropos\n * source repository: https://gitlab.com/foundrynet/dnd5e\n * license: GPLv3\n * @param {*} itemName \n */\nfunction toggleItemBonusDamage(itemName) {\n\tconst speaker = ChatMessage.getSpeaker();\n  let actor;\n\tif ( speaker.token ) \n\t\tactor = game.actors.tokens[speaker.token];\n\tif ( !actor ) \n\t\tactor = game.actors.get(speaker.actor);\n  // Get matching items\n  const items = actor ? actor.items.filter(i => i.name === itemName) : [];\n  if ( items.length > 1 ) {\n    ui.notifications.warn(`Your controlled Actor ${actor.name} has more than one Item with name ${itemName}. The first matched item will be chosen.`);\n  } else if ( items.length === 0 ) {\n    return ui.notifications.warn(`Your controlled Actor does not have an item named ${itemName}`);\n  }\n  const item = items[0];\n\n\tconst newState = !item.getFlag('mess', 'isBonusDamage');\n\t// toggle bonus dmg\n\titem.setFlag('mess', 'isBonusDamage', newState);\n\treturn newState;\n}\n\n/**\n * Initializes all the hoohks!\n */\nfunction setupHooks() {\n\tCONFIG.Item.entityClass.chatListeners  = chatListeners.bind(CONFIG.Item.entityClass);\n\n\tHooks.on('preCreateChatMessage', preCreateChatMessageHook);\n\tHooks.on('renderActorSheet', actorSheetHook);\n\n\t// Bind my own chatListeners to the item class and execute them.\n\t// Hooks.on('ready', chatListeners.bind(CONFIG.Item.entityClass));\n\n\tHooks.on('renderItemSheet', (app, html, data) => {\n\t\tlet div = document.createElement('div');\n\t\tdiv.classList.add('form-group');\n\t\tdiv.appendChild(document.createElement('label')).innerText = game.i18n.localize('MESS.itemSheet.bonusDmg');\n\t\tlet formField = div.appendChild(document.createElement('div'));\n\t\tformField.classList.add('form-fields');\n\t\tlet inp = formField.appendChild(document.createElement('input'));\n\t\tinp.type = 'checkbox';\n\t\tinp.name = 'flags.mess.isBonusDamage';\n\t\tinp.checked = app.object.getFlag('mess', 'isBonusDamage');\n\n\t\tconst target = html[0].querySelector('[name=\"data.formula\"]');\n\t\tif (target)\n\t\t\ttarget.closest('.form-group').after(div);\n\t})\n}\n\n/**\n * Makes sure one attack is rolled for every chat card that has a dmg or attack button.\n * @param {Object} data chat message data\n */\nasync function preCreateChatMessageHook(data) {\n\tconst div = document.createElement('div');\n\tdiv.insertAdjacentHTML('afterbegin',  data.content);\n\tlet btn = div.querySelector('button[data-action=\"attack\"]');\n\tif (!btn)\n\t\tbtn = div.querySelector('button[data-action=\"damage\"]');\n\t\n\tif (btn)\n\t\trenderAttack({currentTarget: btn});\n}\n\n\n// TODO: for compendium rolltables\nfunction getFlavor(chatFlavor, target) {\n\tconst rollTableRegExp = /@RollTable\\[([^\\]])+\\](?:\\{([^\\}]+)\\})?/g;\n\tlet rollTables = Array.from(chatFlavor.matchAll(rollTableRegExp));\n\tif (rollTables) {\n\t\tconst collection = game.tables;\n\t\tfor (let tableData of rollTables) {\n\t\t\tlet table;\n\t\t\tconst id = tableData[0].match(/\\[[a-zA-Z0-9]{16}\\]/);\n\t\t\tif (id) {\n\t\t\t\ttable = collection.get(id[0].slice(1, -1));\n\t\t\t} else {\n\t\t\t\tconst name = tableData[0].match(/\\[([^\\]])+\\]/)[0].slice(1, -1);\n\t\t\t\ttable = collection.entities.find(e => e.data.name === name);\n\t\t\t}\n\t\t\tlet result = table.roll();\n\t\t\tchatFlavor = chatFlavor.replace(tableData[0], result.results.map(e => e.text).join(\",\"));\n\t\t}\n\t}\n\treturn chatFlavor.replace(/\\[target\\.name\\]/g, target.data.name)\n}\n\n\n/**\n * Renders an attack chat card\n * @param {Click Event} ev pointing towards the card that is supposed to initiate the event.\n */\nasync function renderAttack(ev) {\n\tif (ev.type === 'click') {\n\t\tev.preventDefault();\n\t\tev.stopPropagation();\n\t}\n\n\t// Extract card data\n\tconst button = ev.currentTarget;\n\tbutton.disabled = true;\n\tconst card = button.closest(\".chat-card\");\n\n\t// Get the Actor from a synthetic Token\n\tconst actor = CONFIG.Item.entityClass._getChatCardActor(card);\n\n\tif ( !actor || !actor.owner) return;\n\n\t// Get the Item\n\tconst item = actor.getOwnedItem(card.dataset.itemId);\n\tif ( !item ) {\n\t\treturn ui.notifications.error(`The requested item ${card.dataset.itemId} no longer exists on Actor ${actor.name}`)\n\t}\n\n\tlet targets = game.user.targets;\n\t// Don't roll for all targets if its an AoE, due to only rolling e.g. dmg once for all targets\n\t// TODO: Maybe add target list or chat cards for making saving throws\n\t// or not, since it would just spam the chatlog.. hmm\n\tconst areaSkill = Object.keys(CONFIG.DND5E.areaTargetTypes).includes(getProperty(item, 'data.data.target.type'));\n\tif (!targets.size || areaSkill)\n\t\ttargets =  [{data: {\n\t\t\t\tname: \"someone\",\n\t\t\t\timg: \"\"\n\t\t\t}\n\t\t}];\n\tconst spellLevel = parseInt(card.dataset.spellLevel) || null;\n\n\tconst template = 'modules/mess/templates/attack-card.html';\n\n\tconst attackData = {\n\t\tactor, item,\n\t\ttoHit: await getToHitData({actor, item}),\n\t\tdmgs: await getDmgData({actor, item, spellLevel}),\n\t\tsceneId: canvas.scene.id,\n\t\tuser: game.user.id,\n\t\tisGM: game.user.isGM\n\t}\n\n\tconst autoroll = game.settings.get('mess', `${game.userId}.autoroll-selector`);\n\tconst rollMode = game.settings.get(\"core\", \"rollMode\");\n\tfor (const target of targets) {\n\t\tconst allowed = await item._handleResourceConsumption({isCard: false, isAttack: true});\n\t\tconst targetActor = target.actor ? target.actor.data : null;\n\t\tlet targetData = {};\n\t\tif (targetActor) {\n\t\t\ttargetData.ac = {\n\t\t\t\tlabel: '<i class=\"mess-icon ac\"></i>',\n\t\t\t\ttitle: game.i18n.localize('DND5E.ArmorClass'),\n\t\t\t\tvalue: targetActor.data.attributes.ac.value\n\t\t\t}\n\t\t\tlet di = targetActor.data.traits.di.value.filter(e => e !== \"custom\").map(e => game.i18n.localize('DND5E.Damage' + e[0].toUpperCase() + e.substring(1)));\n\t\t\tif (targetActor.data.traits.di.custom)\n\t\t\t\tdi.push(targetActor.data.traits.di.custom);\n\t\t\ttargetData.di = {\n\t\t\t\tlabel: '<i class=\"mess-icon dam-inv\"></i>',\n\t\t\t\ttitle: game.i18n.localize('DND5E.DamImm'),\n\t\t\t\tvalue: di.join(\", \")\n\t\t\t}\n\n\t\t\tlet dr = targetActor.data.traits.dr.value.filter(e => e !== \"custom\").map(e => game.i18n.localize('DND5E.Damage' + e[0].toUpperCase() + e.substring(1)));\n\t\t\tif (targetActor.data.traits.dr.custom) \n\t\t\t\tdr.push(targetActor.data.traits.dr.custom);\n\t\t\ttargetData.dr = {\n\t\t\t\tlabel: '<i class=\"mess-icon dam-res\"></i>',\n\t\t\t\ttitle: game.i18n.localize('DND5E.DamRes'),\n\t\t\t\tvalue: dr.join(\", \")\n\t\t\t}\n\t\t\tlet dv = targetActor.data.traits.dv.value.filter(e => e !== \"custom\").map(e => game.i18n.localize('DND5E.Damage' + e[0].toUpperCase() + e.substring(1)));\n\t\t\tif (targetActor.data.traits.dv.custom)\n\t\t\t\tdv.push(targetActor.data.traits.dv.custom);\n\t\t\ttargetData.dv = {\n\t\t\t\tlabel: '<i class=\"mess-icon dam-vuln\"></i>',\n\t\t\t\ttitle: game.i18n.localize('DND5E.DamVuln'),\n\t\t\t\tvalue: dv.join(\", \")\n\t\t\t}\n\t\t\t// console.log(targetData)\n\t\t}\n\t\tconst attackTemplateData = {\n\t\t\t\t\t\t\t\t\t...attackData, \n\t\t\t\t\t\t\t\t\ttarget: target.data,\n\t\t\t\t\t\t\t\t\ttargetData: targetData,\n\t\t\t\t\t\t\t\t\tflavor: getFlavor(item.data.data.chatFlavor, target),\n\t\t\t\t\t\t\t\t\tallowed\n\t\t\t\t\t\t\t\t};\n\t\tlet html = await renderTemplate(template, attackTemplateData);\n\n\t\t\n\n\t\tif (autoroll.hit || autoroll.dmg) \n\t\t\thtml = await autoRoll(autoroll, html, rollMode);\n\n\n\t\tlet chatData = {\n      user: game.user._id,\n      type: CONST.CHAT_MESSAGE_TYPES.OTHER,\n      content: html,\n      speaker: {\n        actor: item.actor._id,\n        token: item.actor.token,\n        alias: item.actor.name\n\t\t\t}\n\t\t};\n\t\tif (!game.user.isGM || !game.settings.get('mess', 'attack-card-always-public')) {\n\t\t\tif ( [\"gmroll\", \"blindroll\"].includes(rollMode) ) chatData.whisper = ChatMessage.getWhisperRecipients(\"GM\");\n\t\t\t// doesn't work anyway since its no \"real\" roll....\n      // if ( rollMode === \"blindroll\" ) chatData.blind = true;\n      if ( rollMode === \"selfroll\" ) chatData.whisper = [game.user.id];\n\t\t}\n\t\n\t\tChatMessage.create(chatData);\n\t}\n\n\tbutton.disabled = false;\n}\n\n/**\n * Autorolls hit or dmg, depending on which flag is set and replaces the template string.\n * @param {Object} autoroll Defining whether to autoroll hit or dmg\n * @param {String} template Defining the html template where the roll should happen.\n */\nasync function autoRoll(autoroll, template, rollMode) {\n\tlet card = document.createElement('div');\n\tconst dsn = game.mess.diceSoNice; \n\n\tlet whispers = null;\n\tlet blind = false;\n\tif ( [\"gmroll\", \"blindroll\"].includes(rollMode) ) whispers = ChatMessage.getWhisperIDs(\"GM\");\n\tif ( rollMode === \"blindroll\" ) blind = true;\n\tconsole.log(whispers, blind);\n\tcard.classList.add('message');\n\tcard.insertAdjacentHTML('afterbegin', template);\n\tlet rolls = [];\n\tif (autoroll.hit) {\n\t\tlet toHitBtn = card.querySelector('.mess-button-to-hit');\n\t\tif (toHitBtn) {\n\t\t\tlet r = await rollToHit({currentTarget: toHitBtn});\n\t\t\tif (dsn)\n\t\t\t\tawait game.dice3d.showForRoll(r, game.user, true, whispers, blind);\n\t\t}\n\t}\n\n\tif (autoroll.dmg) {\n\t\tconst btns = Array.from(card.querySelectorAll('.mess-button-dmg'));\n\t\tfor (const btn of btns) {\n\t\t\trolls.push(await rollDmg({currentTarget: btn}));\n\t\t}\n\t}\n\tif (dsn)\n\t\tawait game.dice3d.showForRoll(rolls, game.user, true, whispers, blind);\n\telse\t\n\t\tAudioHelper.play({src: CONFIG.sounds.dice}, true);\n\treturn card.innerHTML;\n}\n\n/**\n * Hook onto the Actor Sheet rendering, modifying the listeners for the roll ability and roll skill check events\n * @param {*} app \n * @param {*} html \n * @param {*} data \n */\nasync function actorSheetHook(app, html, data) {\n\t// TODO: Redo this with proper methods... this currently ignores the cool new modifier field\n\t// maybe just ignore replace the abilitysave etc functions\n\tconst abilityMods = html[0].querySelectorAll('.ability-mod, .ability-name');\n\t$(abilityMods).off(); // find smth better here!\n\tabilityMods.forEach(e => e.addEventListener('click', function(ev) {\n\t\tev.stopPropagation();\n\t\tev.preventDefault();\n\n\t\tconst abilityId = ev.currentTarget.closest('.ability').dataset.ability;\n\t\tconst label = CONFIG.DND5E.abilities[abilityId];\n    const abl = app.object.data.data.abilities[abilityId];\n    const parts = [\"@mod\"];\n    const data = {mod: abl.mod};\n    const feats = app.object.data.flags.dnd5e || {};\n\n\t\t// Add feat-related proficiency bonuses\n\t\tconst actorData = getProperty(app.object, \"data.data\")\n    if ( feats.remarkableAthlete && DND5E.characterFlags.remarkableAthlete.abilities.includes(abilityId) ) {\n      parts.push(\"@remarkable-athlete\");\n      data[\"remarkable-athlete\"] = Math.ceil(0.5 * actorData.attributes.prof);\n    }\n    else if ( feats.jackOfAllTrades ) {\n      parts.push(\"@jack-of-all-trades\");\n      data[\"jack-of-all-trades\"] = Math.floor(0.5 * actorData.attributes.prof);\n    }\n\n    // Add global actor bonus\n    let actorBonus = getProperty(app.object.data.data.bonuses, \"abilities.check\");\n    if ( !!actorBonus ) {\n      parts.push(\"@checkBonus\");\n      data.checkBonus = actorBonus;\n\t\t}\n\t\t\n\t\tdata.parts = parts;\n\n\t\tdata.title = game.i18n.format(\"DND5E.AbilityPromptTitle\", {ability: label});\n\n\t\trollD20.bind(app.object)(data);\n\t\treturn false;\n\t}));\n\tconst saveMods = html[0].querySelectorAll('.ability-save');\n\t$(saveMods).off();\n\tsaveMods.forEach(e => e.addEventListener('click', function(ev) {\n\t\tev.stopPropagation();\n\t\tev.preventDefault();\n\t\tconst abilityId = ev.currentTarget.closest('.ability').dataset.ability;\n\t\tconst label = CONFIG.DND5E.abilities[abilityId];\n    const abl = app.object.data.data.abilities[abilityId];\n    const parts = [\"@mod\"];\n    const data = {mod: abl.mod};\n\n    // Include proficiency bonus\n    if ( abl.prof > 0 ) {\n      parts.push(\"@prof\");\n      data.prof = abl.prof;\n    }\n\n    // Include a global actor ability save bonus\n    const actorBonus = getProperty(app.object.data.data.bonuses, \"abilities.save\");\n    if ( !!actorBonus ) {\n      parts.push(\"@saveBonus\");\n      data.saveBonus = actorBonus;\n    }\n\t\tdata.title = game.i18n.format(\"DND5E.SavePromptTitle\", {ability: label});\n\t\tdata.parts = parts;\n\t\trollD20.bind(app.object)(data);\n\t\treturn false;\n\t}));\n\n\tconst skills = html[0].querySelectorAll('.skill-name');\n\t$(skills).off();\n\tskills.forEach(e => e.addEventListener('click', function(ev) {\n\t\tev.stopPropagation();\n\t\tev.preventDefault();\n\t\tconst skillId = ev.currentTarget.closest('.skill').dataset.skill;\n\t\tconst skl = app.object.data.data.skills[skillId];\n\n    // Compose roll parts and data\n    const parts = [\"@mod\"];\n    const data = {mod: skl.mod + skl.prof};\n    if ( skl.bonus ) {\n      data[\"skillBonus\"] = skl.bonus;\n      parts.push(\"@skillBonus\");\n    }\n\n    // Reliable Talent applies to any skill check we have full or better proficiency in\n\t\tdata.reliableTalent = (skl.value >= 1 && app.object.getFlag(\"dnd5e\", \"reliableTalent\"));\n\t\tdata.parts =  parts;\n\t\tdata.title = game.i18n.format(\"DND5E.SkillPromptTitle\", {skill: CONFIG.DND5E.skills[skillId]});\n\n\t\trollD20.bind(app.object)(data);\n\t\treturn false;\n\t}))\n}\n\n/**\n * My own chat listeners\n */\nfunction chatListeners(html) {\n\tif (!html)\n\t\thtml = $(document.getElementById('chat-log'));\n\thtml.on('click', '.card-buttons button', onChatCardAction.bind(this));\n\thtml.on('click', '.item-name', this._onChatCardToggleContent.bind(this));\n\t\n\t// lets just use this for even more listeners\n\thtml.on('mouseenter', '.mess-chat-target', onMouseEnterTarget);\n\thtml.on('mouseleave', '.mess-chat-target', onMouseLeaveTarget);\n\thtml.on('dblclick', '.mess-chat-target', onDblClickTarget);\n\n\thtml.on('click', '.mess-button-to-hit', rollToHit);\n\thtml.on('click', '.mess-button-dmg', rollDmg);\n\n\thtml.on('click', '.mess-show-btn', onToggleShowPlayers);\n}\n\n// Only overwrite stuff for attack buttons\nasync function onChatCardAction (ev) {\n\tev.preventDefault(); ev.stopPropagation();\n\tif (ev.currentTarget.dataset.action === 'attack')\n\t\treturn renderAttack(ev);\n\tif (ev.currentTarget.dataset.action === 'damage')\n\t\treturn renderAttack(ev);\n\tif (ev.currentTarget.dataset.placeTemplate)\n\t\treturn renderTemplate(ev);\n\n\treturn this._onChatCardAction(ev);\t\t\n}\n\n/*****************************************************\n * Mouse Listeners for the target img for chat cards *\n *****************************************************/\n\nasync function onMouseEnterTarget(ev) {\n\tev.preventDefault();\n\tev.stopPropagation();\n\tconst token = await getTargetToken(ev);\n\tif (!token) return false;\n\n\ttoken._onHoverIn();\n}\n\nasync function onMouseLeaveTarget(ev) {\n\tev.preventDefault();\n\tev.stopPropagation();\n\tconst token = await getTargetToken(ev);\n\tif (!token || !token.visible) return false;\n\t\n\ttoken._onHoverOut();\n}\n\nasync function onDblClickTarget(ev) {\n\tev.preventDefault();\n\tev.stopPropagation();\n\tconst token = await getTargetToken(ev);\n\tif (!token || !token.visible) return false;\n\t\n\tconst pos = token.center;\n\tcanvas.animatePan({x: pos.x, y: pos.y});\n}\n\nasync function getTargetToken(ev) {\n\tconst card = ev.currentTarget.closest('.mess-attack-card');\n\tconst sceneId = card.dataset.sceneId;\n\tif (sceneId !== canvas.scene.id) return false;\n\tconst tokenId = card.dataset.targetId;\n\tif (!tokenId) return false;\n\n\tconst token = canvas.tokens.placeables.find(e => e.id === tokenId);\n\tif (!token) return false;\n\treturn token;\n}\n\nasync function onToggleShowPlayers(ev) {\n\tconst div = ev.currentTarget.closest('.mess-chat-to-hit, .mess-chat-dmg');\n\tdiv.classList.toggle('mess-show-players');\n\n\tconst card = ev.currentTarget.closest('.mess-attack-card');\n\tconst messageId = card.closest(\".message\").dataset.messageId;\n\tconst message = game.messages.get(messageId);\n\tmessage.update({content: card.parentNode.innerHTML});\n}","export function getTargetToken(el) {\n\t\n\tconst card = el.closest('.mess-attack-card')\n\n\tconst targetId = card.dataset.targetId\n\tconst sceneId = card.dataset.sceneId;\n\tconst scene = game.scenes.get(sceneId);\n\tconst token = new Token(scene.getEmbeddedEntity(\"Token\", targetId));\n\treturn token;\n}\n\nexport function hasTarget(el) {\n\tconst card = el.closest('.mess-attack-card');\n\tif (!card) return false;\n\tif (card.dataset.targetId) return true;\n\treturn false;\n}","export class MessSettings extends FormApplication {\n\tstatic init() {\n\t\tconst isDnD = game.system.id === 'dnd5e';\n\t\t\n\t\tgame.settings.register('mess', 'actor-item-sort', {\n\t\t\tname: \"Activate item sort button.\",\n\t\t\thint: \"Adds a button to actor sheets for sorting all items of that category alphabetically.\",\n\t\t\tscope: \"world\",\n\t\t\tconfig: false,\n\t\t\tdefault: isDnD,\n\t\t\ttype: Boolean\n\t\t})\n\t\n\t\tgame.settings.register('mess', 'better-draggable', {\n\t\t\tname: \"Activate better drag'n'drop workflow.\",\n\t\t\tscope: \"world\",\n\t\t\tconfig: false,// Change if implemented\n\t\t\tdefault: isDnD,\n\t\t\ttype: Boolean\n\t\t})\n\n\t\tgame.settings.register('mess', 'better-draggable-lists', {\n\t\t\tname: \"Activate better drag'n'drop workflow for lists.\",\n\t\t\tscope: \"world\",\n\t\t\tconfig: false,\n\t\t\tdefault: true,\n\t\t\ttype: Boolean\n\t\t})\n\t\n\t\tgame.settings.register('mess', 'prepared-spell-tracker', {\n\t\t\tname: \"Activate prepared spell tracker\",\n\t\t\thint: \"Adds a tracker to the spellbook tab, providing a way to track the allowed maximum of prepared spells.\",\n\t\t\tscope: \"world\",\n\t\t\tconfig: false,\n\t\t\tdefault: isDnD,\n\t\t\ttype: Boolean\n\t\t})\n\t\n\t\tgame.settings.register('mess', 'add-scrolling', {\n\t\t\tname: \"Activating numerical field scrolling.\",\n\t\t\thint: \"Lets you in-/decrease numerical fields in the Actor sheet using the mouse wheel when focused.\",\n\t\t\tscope: \"world\",\n\t\t\tconfig: false,\n\t\t\tdefault: isDnD,\n\t\t\ttype: Boolean\n\t\t});\n\t\n\t\tgame.settings.register('mess', 'modify-rolling', {\n\t\t\tname: \"Alternative Rolling.\",\n\t\t\thint: \"Changes the way rolling is displayed and executed for DnD5e. Reload for all connected clients is required for this to take effect if changed!\",\n\t\t\tscope: \"world\",\n\t\t\tconfig: false,\n\t\t\tdefault: isDnD,\n\t\t\ttype: Boolean\n\t\t});\n\n\t\tgame.settings.register('mess', 'attack-card-always-public', {\n\t\t\tname: \"Roll mode for alternative rolling.\",\n\t\t\thint: \"Always roll attack rolls public, with hidden rolls, but visible target.\",\n\t\t\tscope: \"world\",\n\t\t\tconfig: false,\n\t\t\tdefault: isDnD,\n\t\t\ttype: Boolean\n\t\t});\n\t\n\t\n\t\tgame.settings.register('mess', 'modify-templates', {\n\t\t\tname: \"Activate modified templates.\",\n\t\t\thint: \"Makes templates texture fill scaling instead of tiling and does allow the usage of videos as texture. Reload for all connected clients is required for this to take effect if changed!\",\n\t\t\tscope: \"world\",\n\t\t\tconfig: false,\n\t\t\tdefault: true,\n\t\t\ttype: Boolean\n\t\t});\n\t\t\n\t\tgame.settings.register('mess', 'change-placeables', {\n\t\t\tname: \"Activate placeables changes.\",\n\t\t\thint: \"Changes some behaviours of placeables, like preview snapping to grid. Reload for all connected clients is required for this to take effect if changed!\",\n\t\t\tscope: \"world\",\n\t\t\tconfig: false,\n\t\t\tdefault: true,\n\t\t\ttype: Boolean\n\t\t});\t\n\t\tgame.settings.registerMenu('mess', 'templateTexture', {\n\t\t\tname: game.i18n.localize('MESS.FVTTSettings.description'),\n\t\t\tlabel: game.i18n.localize('MESS.FVTTSettings.button'),\n\t\t\ticon: \"fas fa-mug-hot\",\n\t\t\ttype: MessSettings,\n\t\t\trestricted: true\n\t\t});\n\n\t\tgame.settings.register('mess', 'templateTexture', {\n\t\t\tname: \"Activate placeables changes.\",\n\t\t\thint: \"Changes some behaviours of placeables, like preview snapping to grid. Reload for all connected clients is required for this to take effect if changed!\",\n\t\t\tscope: \"world\",\n\t\t\tdefault: true,\n\t\t\ttype: Object\n\t\t});\t\n\n\t\tgame.settings.register('mess', 'max-critical', {\n\t\t\tname: \"Activate maximum critical rolls.\",\n\t\t\thint: \"Changes behaviour of critical damage rolls to maximize the damage of the extra dice for criticals!\",\n\t\t\tscope: \"world\",\n\t\t\tconfig: false,\n\t\t\tdefault: false,\n\t\t\ttype: Boolean\n\t\t});\n\n\n\t\tgame.settings.register('mess', 'templateTexture', {\n\t\t\tname: \"Activate placeables changes.\",\n\t\t\thint: \"Changes some behaviours of placeables, like preview snapping to grid. Reload for all connected clients is required for this to take effect if changed!\",\n\t\t\tscope: \"world\",\n\t\t\tconfig: false,\n\t\t\tdefault: true,\n\t\t\ttype: Object\n\t\t});\t\n\n\t\tgame.settings.register('mess', 'templateAutoTargeting', {\n\t\t\tscope: \"world\",\n\t\t\tdefault: true,\n\t\t\ttype: Boolean\n\t\t})\n\n\t\tgame.settings.register('mess', 'templateDrawBordersOnlyOnHighlight', {\n\t\t\tscope: \"world\",\n\t\t\tdefault: true,\n\t\t\ttype: Boolean\n\t\t})\n\n\t\tthis.loadTemplates();\n\t}\n\tstatic loadTemplates() {\n\t\tloadTemplates([\n\t\t\t'modules/mess/templates/settings/templates.html',\n\t\t\t'modules/mess/templates/settings/dnd5e.html',\n\t\t\t'modules/mess/templates/settings/misc.html'\n\t\t]);\n\t}\n\n\tstatic get defaultOptions() {\n\t\treturn {\n\t\t\t...super.defaultOptions,\n\t\t\ttemplate: \"modules/mess/templates/settings/settings.html\",\n\t\t\theight: \"auto\",\n\t\t\ttitle: \"Mess - Moerills enhancing super-suit(e) - Settings Menu\",\n\t\t\twidth: 600,\n\t\t\tclasses: [\"mess\", \"settings\"],\n\t\t\ttabs: [ \n\t\t\t\t{\n\t\t\t\t\tnavSelector: '.tabs',\n\t\t\t\t\tcontentSelector: 'form',\n\t\t\t\t\tinitial: 'name'\n\t\t\t\t} \n\t\t\t],\n\t\t\tsubmitOnClose: true\n\t\t}\n\t}\n\n\tconstructor(object = {}, options) {\n\t\tsuper(object, options);\n\t\tthis.object = game.settings.get('mess', 'templateTexture');\n\t}\n\n\t_getHeaderButtons() {\n\t\tlet btns = super._getHeaderButtons();\n\t\tbtns[0].label = \"Save & Close\";\n\t\treturn btns;\n\t}\n\n\tgetSettingsData() {\n\t\tconst isDnD = game.system.id === 'dnd5e';\n\t\tlet data = {\n\t\t\t'modify-templates': game.settings.get('mess', 'modify-templates'),\n\t\t\t'change-placeables': game.settings.get('mess', 'change-placeables'),\n\t\t\t'templateTexture': game.settings.get('mess', 'templateTexture'),\n\t\t\t'templateAutoTargeting': game.settings.get('mess', 'templateAutoTargeting'),\n\t\t\t'templateDrawBordersOnlyOnHighlight': game.settings.get('mess', 'templateDrawBordersOnlyOnHighlight'),\n\t\t\t'better-draggable-lists': game.settings.get('mess', 'better-draggable-lists')\n\t\t};\n\t\tif (isDnD) {\n\t\t\tdata['templateTexture'] = game.settings.get('mess', 'templateTexture');\n\t\t\tdata['modify-rolling'] = game.settings.get('mess', 'modify-rolling');\n\t\t\tdata['max-critical'] = game.settings.get('mess', 'max-critical');\n\n\t\t\tdata['actor-item-sort'] = game.settings.get('mess', 'actor-item-sort');\n\t\t\t// data['better-draggable'] = game.settings.get('mess', 'better-draggable');\n\t\t\tdata['prepared-spell-tracker'] = game.settings.get('mess', 'prepared-spell-tracker');\n\t\t\tdata['add-scrolling'] = game.settings.get('mess', 'add-scrolling');\n\t\t\tdata['attack-card-always-public'] = game.settings.get('mess', 'attack-card-always-public');\n\t\t}\n\t\treturn data;\n\t}\n\n\tgetData() {\n\t\tconst isDnD = game.system.id === 'dnd5e';\n\t\tlet data = super.getData();\n\t\tif (isDnD) {\n\t\t\tdata.dmgTypes = CONFIG.DND5E.damageTypes;\n\t\t\tdata.templateTypes = CONFIG.MeasuredTemplate.types;\n\t\t}\n\t\tdata.isDnD = isDnD;\n\t\tdata.settings = this.getSettingsData();\n\t\treturn data;\n\t}\n\n\tactivateListeners(html) {\n\t\tsuper.activateListeners(html);\n\t}\n\n\t_updateObject(ev, formData) {\n\t\tconst data = expandObject(formData);\n\t\tfor (let [key, value] of Object.entries(data)) {\n\t\t\tgame.settings.set('mess', key, value);\n\t\t}\n\t\tnew Dialog({\n\t\t\tcontent: `<p>${game.i18n.localize(\"MESS.reloadReminder.text\")}</p>`,\n\t\t\tbuttons: {\n\t\t\t\tyes: {\n\t\t\t\t\ticon: '<i class=\"fas fa-check\"></i>',\n\t\t\t\t\tlabel: game.i18n.localize(\"MESS.reloadReminder.yes\"),\n\t\t\t\t\tcallback: () => location.reload()\n\t\t\t\t},\n\t\t\t\tno: {\n\t\t\t\t\ticon: '<i class=\"fas fa-times\"></i>',\n\t\t\t\t\tlabel: game.i18n.localize(\"MESS.reloadReminder.no\")\n\t\t\t\t}\n\t\t\t}\n\t\t}).render(true);\n\t\t// game.settings.set('mess', 'templateTexture', mergeObject({}, formData))\n\t}\n}"],"sourceRoot":""}